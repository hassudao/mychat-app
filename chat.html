<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyChat - „Éà„Éº„ÇØ„É™„Çπ„Éà</title>

<style>
body {
  font-family:sans-serif;
  padding:20px;
  transition: background 0.3s, color 0.3s;
}
body.dark { background:#1e1e1e; color:#f0f0f0; }

.listContainer { max-width:420px; margin:auto; }

.listItem {
  border:1px solid #ccc;
  padding:10px;
  margin-bottom:5px;
  cursor:pointer;
  display:flex;
  align-items:center;
  background:white;
}
body.dark .listItem { background:#2b2b2b; border-color:#555; }

.userIcon { width:45px; height:45px; border-radius:50%; margin-right:10px; }
.nameBlock { display:flex; flex-direction:column; justify-content:center; flex:1; text-align:left; }
.userName { font-size:15px; font-weight:bold; }
.lastMsg { font-size:14px; margin-top:2px; opacity:0.7; }
.unreadMsg { opacity:1; }

.badge { position:absolute; top:-3px; left:-3px; background:red; color:white; font-size:10px; padding:2px 4px; border-radius:50%; }
.iconWrapper { position:relative; }

.followBtn { padding:5px 8px; cursor:pointer; margin-left:8px; }

#searchBar { width:220px; padding:5px; margin-bottom:10px; }
#darkToggle { padding:5px 10px; margin-bottom:15px; cursor:pointer; }

#notifyBtn { margin-left:10px; padding:5px 10px; cursor:pointer; }

#profileBtn {          /* ‚Üê ËøΩÂä†ÔºÅ */
  margin-left:10px;
  padding:5px 10px;
  cursor:pointer;
  background:#4e8cff;
  color:white;
  border:none;
  border-radius:6px;
}

#notifyPopup {
  display:none;
  position:absolute;
  right:20px;
  top:120px;
  width:260px;
  background:white;
  border:1px solid #ccc;
  padding:10px;
  z-index:999;
  max-height:300px;
  overflow-y:auto;
}
body.dark #notifyPopup { background:#2b2b2b; border-color:#555; color:white; }
.notifyItem { border-bottom:1px solid #ccc; padding:8px; }
.fbBtn { margin-top:5px; padding:5px; cursor:pointer; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
<h2>MyChat</h2>

<button id="darkToggle">„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø</button>

<!-- üîç Ê§úÁ¥¢„Éê„Éº Ôºã üîîÈÄöÁü• Ôºã ‚öô„Éó„É≠„ÉïË®≠ÂÆö „ÇíÊ®™‰∏¶„Å≥ -->
<div style="display:flex; align-items:center; margin-bottom:10px;">
  <input type="text" id="searchBar" placeholder="„É¶„Éº„Ç∂„Éº„ÇíÊ§úÁ¥¢...">
  <button id="notifyBtn">üîî</button>

  <!-- üîß „Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ„Éú„Çø„É≥ÔºàËøΩÂä†Ôºâ -->
  <button id="profileBtn">‚öô „Éó„É≠„Éï„Ç£„Éº„É´</button>
</div>

<div id="notifyPopup"></div>
<div id="searchResults" class="listContainer" style="display:none;"></div>

<h3>„ÉÅ„É£„ÉÉ„Éà‰∏ÄË¶ß</h3>
<div id="chatList" class="listContainer"></div>

<h3>„Éï„Ç©„É≠„Éº‰∏≠‰∏ÄË¶ß</h3>
<div id="followList" class="listContainer"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

const searchBar = document.getElementById("searchBar");
const searchResultsDiv = document.getElementById("searchResults");
const chatListDiv = document.getElementById("chatList");
const followListDiv = document.getElementById("followList");
const notifyBtn = document.getElementById("notifyBtn");
const notifyPopup = document.getElementById("notifyPopup");
const darkToggle = document.getElementById("darkToggle");

let currentUser=null;

/* ‚ñº ËøΩÂä†Ôºö„Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö„Éú„Çø„É≥ */
document.getElementById("profileBtn").onclick = ()=>{
  location.href="profile.html";
};

/* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
if(localStorage.getItem("darkMode")==="true") document.body.classList.add("dark");
darkToggle.onclick = ()=>{ document.body.classList.toggle("dark"); localStorage.setItem("darkMode", document.body.classList.contains("dark")); };

/* „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã */
auth.onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  currentUser=user;
  loadChats();
  loadFollows();
  loadNotifications();
});

/* ÈÄöÁü•„Çª„É≥„Çø„Éº */
notifyBtn.onclick = ()=>{ notifyPopup.style.display = (notifyPopup.style.display==="none"||notifyPopup.style.display==="")?"block":"none"; };

function loadNotifications(){
  database.ref("notifications/"+currentUser.uid+"/list").limitToLast(10)
  .on("value", snap=>{
    const data=snap.val()||{};
    const arr = Object.values(data).sort((a,b)=>b.time-a.time);
    displayNotifications(arr);
  });
}

function displayNotifications(list){
  notifyPopup.innerHTML="";
  if(list.length===0){ notifyPopup.innerHTML="<div>ÈÄöÁü•„ÅØ„Å™„ÅÑ„Åå„Å≠„Äú</div>"; return; }

  list.forEach(n=>{
    const div=document.createElement("div");
    div.className="notifyItem";
    div.innerHTML=`<div>${n.message}</div><button class="fbBtn" data-id="${n.from}">„Éï„Ç©„É≠„Éº„Éê„ÉÉ„ÇØ</button>`;
    notifyPopup.appendChild(div);
  });

  document.querySelectorAll(".fbBtn").forEach(btn=>{
    btn.onclick=e=>{ followBack(e.target.dataset.id); };
  });
}

function followBack(uid){
  database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{
    let arr=s.val()||[];
    if(!arr.includes(uid)) arr.push(uid);
    database.ref("users/"+currentUser.uid+"/following").set(arr);
  });
  database.ref("notifications/"+currentUser.uid+"/list").once("value").then(s=>{
    const data=s.val()||{};
    for(const k in data){ if(data[k].from===uid) database.ref("notifications/"+currentUser.uid+"/list/"+k).remove(); }
  });
}

function pushFollowNotification(targetId){
  const ref=database.ref("notifications/"+targetId+"/list").push();
  const d={id:ref.key, from:currentUser.uid, message:`${currentUser.displayName} „Åï„Çì„Åå„ÅÇ„Å™„Åü„Çí„Éï„Ç©„É≠„Éº„Åó„Åü„Åå„Å≠ÔºÅ`, time:Date.now()};
  ref.set(d);
  database.ref("notifications/"+targetId+"/list").once("value").then(s=>{
    const list=s.val()||{};
    const keys=Object.keys(list);
    if(keys.length>10){
      let oldest=keys[0]; let ot=list[oldest].time;
      keys.forEach(k=>{ if(list[k].time<ot){ oldest=k; ot=list[k].time; } });
      database.ref("notifications/"+targetId+"/list/"+oldest).remove();
    }
  });
}

/* „ÉÅ„É£„ÉÉ„Éà‰∏ÄË¶ß */
function loadChats(){
  database.ref("chats/"+currentUser.uid+"/list").on("value", snap=>{
    const data=snap.val()||{};
    const arr=[]; const tasks=[];
    for(const uid in data){
      tasks.push(
        database.ref("users/"+uid).once("value").then(us=>{
          const u=us.val(); if(!u){ database.ref("chats/"+currentUser.uid+"/list/"+uid).remove(); return; }
          arr.push({id:uid, displayName:u.displayName, photoURL:u.photoURL||"https://via.placeholder.com/40", lastMessage:data[uid].lastMessage||"", unread:data[uid].unread||0});
        })
      );
    }
    Promise.all(tasks).then(()=>displayChats(arr));
  });
}

function displayChats(list){
  chatListDiv.innerHTML="";
  list.forEach(u=>{ chatListDiv.appendChild(createUserDiv(u,"chat")); });
}

/* „Éï„Ç©„É≠„Éº‰∏≠‰∏ÄË¶ß */
function loadFollows(){
  database.ref("users/"+currentUser.uid+"/following").on("value", snap=>{
    const arr=snap.val()||[]; const out=[]; const tasks=[];
    arr.forEach(uid=>{
      tasks.push(database.ref("users/"+uid).once("value").then(us=>{ const u=us.val(); if(!u) return; out.push({id:uid, displayName:u.displayName, photoURL:u.photoURL||"https://via.placeholder.com/40"}); }));
    });
    Promise.all(tasks).then(()=>displayFollows(out));
  });
}

function displayFollows(list){
  followListDiv.innerHTML="";
  list.forEach(u=>{ followListDiv.appendChild(createUserDiv(u,"follow")); });
}

/* ÂÖ±ÈÄö„É¶„Éº„Ç∂„ÉºË°åÁîüÊàê */
function createUserDiv(user, mode){
  const div=document.createElement("div"); div.className="listItem";

  const iconWrapper=document.createElement("div"); iconWrapper.className="iconWrapper";
  const img=document.createElement("img"); img.className="userIcon"; img.src=user.photoURL;
  iconWrapper.appendChild(img);
  if(user.unread>0){ const badge=document.createElement("div"); badge.className="badge"; badge.textContent=user.unread; iconWrapper.appendChild(badge); }

  const nameBlock=document.createElement("div"); nameBlock.className="nameBlock";
  const name=document.createElement("div"); name.className="userName"; name.textContent=user.displayName;
  nameBlock.appendChild(name);
  if(user.lastMessage!==undefined){ const msg=document.createElement("div"); msg.className="lastMsg"; msg.textContent=user.lastMessage; if(user.unread>0) msg.classList.add("unreadMsg"); nameBlock.appendChild(msg); }

  div.appendChild(iconWrapper); div.appendChild(nameBlock);

  /* Ê§úÁ¥¢„Éï„Ç©„É≠„Éº„Éú„Çø„É≥ */
  if(mode==="search"){
    const btn=document.createElement("button"); btn.className="followBtn";
    database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{ const arr=s.val()||[]; btn.textContent = arr.includes(user.id)?"„Éï„Ç©„É≠„Éº‰∏≠":"„Éï„Ç©„É≠„Éº"; });
    btn.onclick=e=>{
      e.stopPropagation();
      database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{
        let arr=s.val()||[];
        if(arr.includes(user.id)){ arr=arr.filter(v=>v!==user.id); btn.textContent="„Éï„Ç©„É≠„Éº"; }
        else{ arr.push(user.id); btn.textContent="„Éï„Ç©„É≠„Éº‰∏≠"; pushFollowNotification(user.id); }
        database.ref("users/"+currentUser.uid+"/following").set(arr);
      });
    };
    div.appendChild(btn);
  }

  /* „Éï„Ç©„É≠„Éº‰∏≠Ëß£Èô§„Éú„Çø„É≥ */
  if(mode==="follow"){
    const btn=document.createElement("button"); btn.className="followBtn"; btn.textContent="Ëß£Èô§";
    btn.onclick=e=>{
      e.stopPropagation();
      database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{
        let arr=s.val()||[]; arr=arr.filter(id=>id!==user.id);
        database.ref("users/"+currentUser.uid+"/following").set(arr);
      });
    };
    div.appendChild(btn);
  }

  /* DMÈÅ∑ÁßªÔºàÁõ∏‰∫í„Éï„Ç©„É≠„Éº„ÅÆ„ÅøÔºâ */
  div.onclick=()=>{
    if(mode==="search") return;
    Promise.all([
      database.ref("users/"+user.id+"/following").once("value"),
      database.ref("users/"+currentUser.uid+"/following").once("value")
    ]).then(([theirSnap,mySnap])=>{
      const their = theirSnap.val()||[];
      const mine = mySnap.val()||[];
      if(their.includes(currentUser.uid) && mine.includes(user.id)){
        location.href="dm.html?opponentId="+user.id;
      } else { alert("Áõ∏‰∫í„Éï„Ç©„É≠„Éº„ÅÆÁõ∏Êâã„ÅÆ„ÅøDM„Åß„Åç„Çã„Åå„Å≠ÔºÅ"); }
    });
  };

  return div;
}

/* Ê§úÁ¥¢ */
searchBar.addEventListener("input", ()=>{
  const kw=searchBar.value.trim().toLowerCase();
  if(!kw){ searchResultsDiv.style.display="none"; return; }
  searchResultsDiv.style.display="block"; searchResultsDiv.innerHTML="";
  database.ref("users").once("value").then(s=>{
    const users=s.val()||{};
    for(const uid in users){
      if(uid===currentUser.uid) continue;
      const u=users[uid]; const name=(u.displayName||"").toLowerCase();
      if(name.includes(kw)||uid.includes(kw)){
        searchResultsDiv.appendChild(createUserDiv({id:uid, displayName:u.displayName, photoURL:u.photoURL||"https://via.placeholder.com/40"}, "search"));
      }
    }
  });
});
</script>
</body>
</html>
