<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyChat ãƒ•ã‚©ãƒ­ãƒ¼ç‰ˆ</title>
<style>
body { font-family:sans-serif; margin:0; display:flex; height:100vh; }
body.dark { background-color:#1e1e1e; color:#f0f0f0; }
#userList { width:180px; border-right:1px solid #ccc; overflow-y:auto; padding:10px; }
#chatContainer { flex:1; display:flex; flex-direction:column; padding:10px; }
#messages { flex:1; overflow-y:scroll; border:1px solid #ccc; padding:10px; margin-bottom:6px; display:flex; flex-direction:column; }
.message { display:flex; align-items:flex-start; margin-bottom:6px; }
.avatar { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0; }
.content { background:#f0f0f0; padding:6px 10px; border-radius:12px; max-width:300px; word-wrap:break-word; }
.myMessage { justify-content:flex-end; }
.myMessage .content { background:#007bff; color:#fff; margin-left:8px; }
.myMessage .avatar { order:2; margin-left:8px; margin-right:0; }
.otherMessage { justify-content:flex-start; }
.otherMessage .content { margin-right:8px; }
body.dark .content { background:#333; color:#fff; }
#inputArea { display:flex; }
#msgInput { flex:1; padding:5px; }
button { padding:5px 10px; margin-left:4px; }
.userItem { cursor:pointer; padding:4px; border-radius:4px; display:flex; justify-content:space-between; align-items:center; }
.userItem:hover { background:#ddd; }
body.dark .userItem:hover { background:#444; }
.activeUser { background:#aaa !important; }
#friendSearch { width:100%; padding:4px; margin-bottom:4px; box-sizing:border-box; }
#searchResults { max-height:150px; overflow-y:auto; border:1px solid #ccc; padding:4px; margin-bottom:6px; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div id="userList">
  <h4>ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</h4>
  <div id="users"></div>
  <input type="text" id="friendSearch" placeholder="IDãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»åå‰ã§æ¤œç´¢">
  <div id="searchResults"></div>
</div>
<div id="chatContainer">
  <div>
    <button id="modeToggle">ğŸŒ™ / â˜€ï¸ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
    <button id="settingsBtn">âš™ï¸ è¨­å®š</button>
  </div>
  <div id="messages"></div>
  <div id="inputArea">
    <input type="text" id="msgInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›â€¦">
    <button id="sendBtn">é€ä¿¡ï¼</button>
  </div>
</div>

<script>
// Firebase åˆæœŸåŒ–
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// ----------------- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ -----------------
const toggleButton = document.getElementById("modeToggle");
const bodyEl = document.body;
toggleButton.addEventListener("click", ()=>{
  bodyEl.classList.toggle("dark");
  localStorage.setItem("mode", bodyEl.classList.contains("dark") ? "dark" : "light");
});
window.addEventListener("load", ()=>{
  if(localStorage.getItem("mode")==="dark") bodyEl.classList.add("dark");
});

// ----------------- è¨­å®š -----------------
document.getElementById("settingsBtn").addEventListener("click", ()=>location.href="settings.html");

// ----------------- ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ -----------------
let currentUser=null;
auth.onAuthStateChanged(user=>{
  if(!user) location.href="index.html";
  currentUser=user;
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’DBã«ä¿å­˜
  database.ref("users/"+user.uid).set({
    displayName: user.displayName || "åç„¡ã—",
    photoURL: user.photoURL || "",
    email: user.email || ""
  });
  loadFollowedUsers();
});

// ----------------- ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º -----------------
const usersDiv = document.getElementById("users");
let selectedUserId=null;
function loadFollowedUsers(){
  database.ref("follows/"+currentUser.uid).on("value", snapshot=>{
    usersDiv.innerHTML="";
    const data=snapshot.val();
    if(data){
      Object.keys(data).forEach(uid=>{
        database.ref("users/"+uid).get().then(snap=>{
          if(snap.exists()){
            const user=snap.val();
            const div=document.createElement("div");
            div.textContent=user.displayName;
            div.classList.add("userItem");
            div.dataset.uid=uid;
            div.addEventListener("click", ()=>{
              selectUser(uid, user.displayName);
              document.querySelectorAll(".userItem").forEach(el=>el.classList.remove("activeUser"));
              div.classList.add("activeUser");
            });
            usersDiv.appendChild(div);
          }
        });
      });
    }
  });
}

// ----------------- æ¤œç´¢ + ãƒ•ã‚©ãƒ­ãƒ¼ -----------------
const searchBtn=document.getElementById("friendSearch");
const searchResults=document.getElementById("searchResults");
searchBtn.addEventListener("input", ()=>{
  const keyword=searchBtn.value.toLowerCase();
  database.ref("users").once("value").then(snapshot=>{
    const data=snapshot.val();
    const results=[];
    Object.entries(data).forEach(([uid,user])=>{
      if(uid===currentUser.uid) return;
      if(uid.toLowerCase().includes(keyword) ||
         (user.email && user.email.toLowerCase().includes(keyword)) ||
         (user.displayName && user.displayName.toLowerCase().includes(keyword))){
        results.push({uid, ...user});
      }
    });
    showSearchResults(results);
  });
});

function showSearchResults(results){
  searchResults.innerHTML="";
  results.forEach(user=>{
    const div=document.createElement("div");
    div.classList.add("userItem");
    div.textContent=user.displayName+" ("+user.email+")";
    const followBtn=document.createElement("button");
    followBtn.textContent="ãƒ•ã‚©ãƒ­ãƒ¼";
    followBtn.addEventListener("click", ()=>{
      database.ref("follows/"+currentUser.uid+"/"+user.uid).set(true);
      alert("ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ãŸï¼");
      div.remove();
    });
    div.appendChild(followBtn);
    searchResults.appendChild(div);
  });
}

// ----------------- DMé¸æŠ -----------------
const messagesDiv=document.getElementById("messages");
function selectUser(uid,name){
  selectedUserId=null;
  // ç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼ãƒã‚§ãƒƒã‚¯
  database.ref("follows/"+uid+"/"+currentUser.uid).get().then(snap=>{
    if(snap.exists()){
      selectedUserId=uid;
      messagesDiv.innerHTML="";
      const roomId=[currentUser.uid,uid].sort().join("_");
      database.ref("dm/"+roomId+"/messages").on("value", snapshot=>{
        messagesDiv.innerHTML="";
        const data=snapshot.val();
        if(data){
          Object.values(data).sort((a,b)=>a.timestamp-b.timestamp).forEach(m=>{
            const div=document.createElement("div");
            div.classList.add("message");
            if(m.username===currentUser.displayName){
              div.classList.add("myMessage");
            }else{
              div.classList.add("otherMessage");
            }

            const avatarDiv=document.createElement("div");
            avatarDiv.classList.add("avatar");
            if(m.photoURL){
              const img=document.createElement("img");
              img.src=m.photoURL;
              img.style.width="32px";
              img.style.height="32px";
              img.style.borderRadius="50%";
              avatarDiv.appendChild(img);
            }else{
              avatarDiv.textContent=m.username[0].toUpperCase();
              avatarDiv.style.backgroundColor="#666";
              avatarDiv.style.color="#fff";
              avatarDiv.style.display="flex";
              avatarDiv.style.alignItems="center";
              avatarDiv.style.justifyContent="center";
            }

            const contentDiv=document.createElement("div");
            contentDiv.classList.add("content");
            contentDiv.textContent=m.content;

            div.appendChild(avatarDiv);
            div.appendChild(contentDiv);
            messagesDiv.appendChild(div);
          });
          messagesDiv.scrollTop=messagesDiv.scrollHeight;
        }
      });
    } else {
      alert("ç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿DMå¯èƒ½ã§ã™ï¼");
    }
  });
}

// ----------------- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ -----------------
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
sendBtn.addEventListener("click", sendMessage);
msgInput.addEventListener("keypress", e=>{ if(e.key==="Enter") sendMessage(); });

function sendMessage(){
  if(!selectedUserId) return alert("DMå¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„");
  const content=msgInput.value.trim();
  if(!content) return;
  const roomId=[currentUser.uid,selectedUserId].sort().join("_");
  database.ref("dm/"+roomId+"/messages").push({
    username: currentUser.displayName || "åç„¡ã—",
    photoURL: currentUser.photoURL || "",
    content: content,
    timestamp: Date.now()
  });
  msgInput.value="";
}
</script>
</body>
</html>
