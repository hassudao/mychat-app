<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MyChat ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    body { font-family:sans-serif; text-align:center; padding:20px; }
    body.dark { background-color:#1e1e1e; color:#f0f0f0; }
    #messages { height:400px; overflow-y:scroll; border:1px solid #ccc; margin:10px auto; width:300px; padding:10px; text-align:left; }
    .message { padding:4px 8px; border-radius:8px; margin-bottom:4px; background-color:#f0f0f0; }
    body.dark .message { background-color:#333333; color:#ffffff; }
    #msgInput { width:200px; padding:5px; }
    button { padding:5px 10px; margin:4px; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h2>
  <button id="modeToggle">ğŸŒ™ / â˜€ï¸ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
  <div id="messages"></div>
  <input type="text" id="msgInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›â€¦">
  <button id="sendBtn">é€ä¿¡ï¼</button>

  <script>
    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
      authDomain: "chatapp-hassu.firebaseapp.com",
      databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chatapp-hassu",
      storageBucket: "chatapp-hassu.firebasestorage.app",
      messagingSenderId: "8489684752",
      appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const toggleButton = document.getElementById("modeToggle");
    const body = document.body;

    // -------------------------
    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    // -------------------------
    toggleButton.addEventListener("click", ()=>{
      body.classList.toggle("dark");
      localStorage.setItem("mode", body.classList.contains("dark") ? "dark" : "light");
    });

    window.addEventListener("load", ()=>{
      if(localStorage.getItem("mode") === "dark"){
        body.classList.add("dark");
      }
    });

    // -------------------------
    // Firebase Auth: æœªãƒ­ã‚°ã‚¤ãƒ³ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«é£›ã°ã™
    // -------------------------
    auth.onAuthStateChanged(user=>{
      if(!user) location.href = "index.html";
    });

    // -------------------------
    // é€ä¿¡å‡¦ç†
    // -------------------------
    sendBtn.addEventListener("click", sendMessage);
    msgInput.addEventListener("keypress", e=>{ if(e.key==="Enter") sendMessage(); });

    function sendMessage(){
      const user = auth.currentUser;
      if(!user) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¾ã›ã‚“");
      const content = msgInput.value.trim();
      if(!content) return;
      database.ref("messages").push({
        username: user.email.split("@")[0],
        content: content,
        timestamp: Date.now()
      });
      msgInput.value = "";
    }

    // -------------------------
    // å—ä¿¡å‡¦ç†ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
    // -------------------------
    database.ref("messages").on("value", snapshot=>{
      messagesDiv.innerHTML = "";
      const data = snapshot.val();
      if(data){
        Object.values(data).sort((a,b)=>a.timestamp-b.timestamp).forEach(m=>{
          const div = document.createElement("div");
          div.classList.add("message");
          div.innerHTML = `<b>${m.username}</b>: ${m.content}`;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    });
  </script>
</body>
</html>
