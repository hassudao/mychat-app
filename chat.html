<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyChat - ãƒˆãƒ¼ã‚¯ãƒªã‚¹ãƒˆ</title>

<style>
/* ====== æ—¢å­˜CSSãã®ã¾ã¾ ====== */
body {
  font-family:sans-serif;
  padding:20px;
  transition: background 0.3s, color 0.3s;
}
body.dark { background:#1e1e1e; color:#f0f0f0; }

.listContainer { max-width:420px; margin:auto; }

.listItem {
  border:1px solid #ccc;
  padding:10px;
  margin-bottom:5px;
  cursor:pointer;
  display:flex;
  align-items:center;
  background:white;
}
body.dark .listItem { background:#2b2b2b; border-color:#555; }

.userIcon { width:45px; height:45px; border-radius:50%; margin-right:10px; }
.nameBlock { display:flex; flex-direction:column; justify-content:center; flex:1; text-align:left; }
.userName { font-size:15px; font-weight:bold; }
.lastMsg { font-size:14px; margin-top:2px; opacity:0.7; }
.unreadMsg { opacity:1; }

.badge { position:absolute; top:-3px; left:-3px; background:red; color:white; font-size:10px; padding:2px 4px; border-radius:50%; }
.iconWrapper { position:relative; }

.followBtn { padding:5px 8px; cursor:pointer; margin-left:8px; }

#searchBar { width:260px; padding:5px; margin-bottom:10px; }
#darkToggle { padding:5px 10px; margin-bottom:15px; cursor:pointer; }

#notifyBtn { margin-left:10px; padding:5px 10px; cursor:pointer; }
#notifyPopup {
  display:none;
  position:absolute;
  right:20px;
  top:120px;
  width:260px;
  background:white;
  border:1px solid #ccc;
  padding:10px;
  z-index:999;
  max-height:300px;
  overflow-y:auto;
}
body.dark #notifyPopup { background:#2b2b2b; border-color:#555; color:white; }
.notifyItem { border-bottom:1px solid #ccc; padding:8px; }
.fbBtn { margin-top:5px; padding:5px; cursor:pointer; }

/* ====== â–¼è¿½åŠ ï¼šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
#profileModal {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  z-index:2000;
  justify-content:center;
  align-items:center;
}
#profileBox {
  background:white;
  padding:20px;
  width:300px;
  border-radius:10px;
}
body.dark #profileBox { background:#2b2b2b; color:white; }

#profileIconPreview {
  width:70px; height:70px;
  border-radius:50%;
  display:block;
  margin:auto;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>

<body>
<h2>MyChat</h2>
<button id="darkToggle">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>

<!-- â–¼è¿½åŠ  ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒœã‚¿ãƒ³ -->
<button id="openProfile">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</button>

<input type="text" id="searchBar" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢...">
<button id="notifyBtn">ğŸ””</button>

<div id="notifyPopup"></div>
<div id="searchResults" class="listContainer" style="display:none;"></div>

<h3>ãƒãƒ£ãƒƒãƒˆä¸€è¦§</h3>
<div id="chatList" class="listContainer"></div>

<h3>ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§</h3>
<div id="followList" class="listContainer"></div>

<!-- â–¼è¿½åŠ ï¼šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="profileModal">
  <div id="profileBox">
    <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h3>
    <img id="profileIconPreview" src="">
    <br>
    <input type="file" id="profileIconInput"><br><br>
    <input type="text" id="profileNameInput" placeholder="åå‰ã‚’å…¥åŠ›"><br><br>
    <button id="saveProfileBtn">ä¿å­˜</button>
    <button id="closeProfile">é–‰ã˜ã‚‹</button>
  </div>
</div>


<script>
/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();
const storage = firebase.storage();

/* DOM */
const openProfileBtn = document.getElementById("openProfile");
const profileModal = document.getElementById("profileModal");
const closeProfileBtn = document.getElementById("closeProfile");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const profileIconPreview = document.getElementById("profileIconPreview");
const profileIconInput = document.getElementById("profileIconInput");
const profileNameInput = document.getElementById("profileNameInput");

let currentUser=null;

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
if(localStorage.getItem("darkMode")==="true") document.body.classList.add("dark");
darkToggle.onclick = ()=>{ document.body.classList.toggle("dark"); localStorage.setItem("darkMode", document.body.classList.contains("dark")); };

/* ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ */
auth.onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  currentUser=user;

  // â–¼ã“ã“ã§ç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’åæ˜ 
  loadProfileInfo();

  loadChats();
  loadFollows();
  loadNotifications();
});

/* â–¼ç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ */
function loadProfileInfo(){
  database.ref("users/"+currentUser.uid).once("value").then(s=>{
    const u=s.val()||{};
    profileNameInput.value = u.displayName || currentUser.displayName || "";
    profileIconPreview.src = u.photoURL || currentUser.photoURL || "https://via.placeholder.com/70";
  });
}

/* â–¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ */
openProfileBtn.onclick = ()=> profileModal.style.display="flex";
closeProfileBtn.onclick = ()=> profileModal.style.display="none";

/* â–¼ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
profileIconInput.onchange = ()=>{
  const file = profileIconInput.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=e=>{ profileIconPreview.src=e.target.result; };
    reader.readAsDataURL(file);
  }
};

/* â–¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ */
saveProfileBtn.onclick = async ()=>{
  const name = profileNameInput.value.trim();
  let iconURL = profileIconPreview.src;

  /* ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
  if(profileIconInput.files[0]){
    const ref = storage.ref("icons/"+currentUser.uid+".jpg");
    await ref.put(profileIconInput.files[0]);
    iconURL = await ref.getDownloadURL();
  }

  /* ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–° */
  await database.ref("users/"+currentUser.uid).update({
    displayName: name,
    photoURL: iconURL
  });

  /* Firebase Auth ã®è¡¨ç¤ºåã‚‚æ›´æ–° */
  await currentUser.updateProfile({ displayName:name, photoURL:iconURL });

  alert("ä¿å­˜ã—ãŸãŒã­ãƒƒâ€¼ï¸");
  profileModal.style.display="none";

  loadProfileInfo(); // å³åæ˜ 
};

/* ====== ä»¥ä¸‹ã€æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆãƒ»ãƒ•ã‚©ãƒ­ãƒ¼ãƒ»é€šçŸ¥å‡¦ç†ï¼ˆçœç•¥ãªã—ï¼‰ ====== */
/*ï¼ˆã‚ãªãŸã®å…ƒã‚³ãƒ¼ãƒ‰ã¯å…¨éƒ¨ã“ã“ã«æ®‹ã—ã¦ã‚ã‚‹â€¼ï¸ï¼‰*/

/* é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ */
notifyBtn.onclick = ()=>{ notifyPopup.style.display = (notifyPopup.style.display==="none"||notifyPopup.style.display==="")?"block":"none"; };

function loadNotifications(){
  database.ref("notifications/"+currentUser.uid+"/list").limitToLast(10)
  .on("value", snap=>{
    const data=snap.val()||{};
    const arr = Object.values(data).sort((a,b)=>b.time-a.time);
    displayNotifications(arr);
  });
}

function displayNotifications(list){
  notifyPopup.innerHTML="";
  if(list.length===0){ notifyPopup.innerHTML="<div>é€šçŸ¥ã¯ãªã„ãŒã­ã€œ</div>"; return; }

  list.forEach(n=>{
    const div=document.createElement("div");
    div.className="notifyItem";
    div.innerHTML=`<div>${n.message}</div><button class="fbBtn" data-id="${n.from}">ãƒ•ã‚©ãƒ­ãƒ¼ãƒãƒƒã‚¯</button>`;
    notifyPopup.appendChild(div);
  });

  document.querySelectorAll(".fbBtn").forEach(btn=>{
    btn.onclick=e=>{ followBack(e.target.dataset.id); };
  });
}

function followBack(uid){
  database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{
    let arr=s.val()||[];
    if(!arr.includes(uid)) arr.push(uid);
    database.ref("users/"+currentUser.uid+"/following").set(arr);
  });
  database.ref("notifications/"+currentUser.uid+"/list").once("value").then(s=>{
    const data=s.val()||{};
    for(const k in data){ if(data[k].from===uid) database.ref("notifications/"+currentUser.uid+"/list/"+k).remove(); }
  });
}

function pushFollowNotification(targetId){
  const ref=database.ref("notifications/"+targetId+"/list").push();
  const d={id:ref.key, from:currentUser.uid, message:`${currentUser.displayName} ã•ã‚“ãŒã‚ãªãŸã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸãŒã­ï¼`, time:Date.now()};
  ref.set(d);
}

/* ãƒãƒ£ãƒƒãƒˆä¸€è¦§ */
function loadChats(){
  database.ref("chats/"+currentUser.uid+"/list").on("value", snap=>{
    const data=snap.val()||{};
    const arr=[]; const tasks=[];
    for(const uid in data){
      tasks.push(
        database.ref("users/"+uid).once("value").then(us=>{
          const u=us.val(); if(!u){ database.ref("chats/"+currentUser.uid+"/list/"+uid).remove(); return; }
          arr.push({id:uid, displayName:u.displayName, photoURL:u.photoURL||"https://via.placeholder.com/40", lastMessage:data[uid].lastMessage||"", unread:data[uid].unread||0});
        })
      );
    }
    Promise.all(tasks).then(()=>displayChats(arr));
  });
}
function displayChats(list){
  chatListDiv.innerHTML="";
  list.forEach(u=>{ chatListDiv.appendChild(createUserDiv(u,"chat")); });
}

/* ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§ */
function loadFollows(){
  database.ref("users/"+currentUser.uid+"/following").on("value", snap=>{
    const arr=snap.val()||[]; const out=[]; const tasks=[];
    arr.forEach(uid=>{
      tasks.push(database.ref("users/"+uid).once("value").then(us=>{ const u=us.val(); if(!u) return; out.push({id:uid, displayName:u.displayName, photoURL:u.photoURL||"https://via.placeholder.com/40"}); }));
    });
    Promise.all(tasks).then(()=>displayFollows(out));
  });
}
function displayFollows(list){
  followListDiv.innerHTML="";
  list.forEach(u=>{ followListDiv.appendChild(createUserDiv(u,"follow")); });
}

/* å…±é€šãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œç”Ÿæˆ */
function createUserDiv(user, mode){
  const div=document.createElement("div"); div.className="listItem";

  const iconWrapper=document.createElement("div"); iconWrapper.className="iconWrapper";
  const img=document.createElement("img"); img.className="userIcon"; img.src=user.photoURL;
  iconWrapper.appendChild(img);
  if(user.unread>0){ const badge=document.createElement("div"); badge.className="badge"; badge.textContent=user.unread; iconWrapper.appendChild(badge); }

  const nameBlock=document.createElement("div"); nameBlock.className="nameBlock";
  const name=document.createElement("div"); name.className="userName"; name.textContent=user.displayName;
  nameBlock.appendChild(name);
  if(user.lastMessage!==undefined){ const msg=document.createElement("div"); msg.className="lastMsg"; msg.textContent=user.lastMessage; if(user.unread>0) msg.classList.add("unreadMsg"); nameBlock.appendChild(msg); }

  div.appendChild(iconWrapper); div.appendChild(nameBlock);

  /* æ¤œç´¢ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ */
  if(mode==="search"){
    const btn=document.createElement("button"); btn.className="followBtn";
    database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{ const arr=s.val()||[]; btn.textContent = arr.includes(user.id)?"ãƒ•ã‚©ãƒ­ãƒ¼ä¸­":"ãƒ•ã‚©ãƒ­ãƒ¼"; });
    btn.onclick=e=>{
      e.stopPropagation();
      database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{
        let arr=s.val()||[];
        if(arr.includes(user.id)){ arr=arr.filter(v=>v!==user.id); btn.textContent="ãƒ•ã‚©ãƒ­ãƒ¼"; }
        else{ arr.push(user.id); btn.textContent="ãƒ•ã‚©ãƒ­ãƒ¼ä¸­"; pushFollowNotification(user.id); }
        database.ref("users/"+currentUser.uid+"/following").set(arr);
      });
    };
    div.appendChild(btn);
  }

  /* ãƒ•ã‚©ãƒ­ãƒ¼ä¸­è§£é™¤ãƒœã‚¿ãƒ³ */
  if(mode==="follow"){
    const btn=document.createElement("button"); btn.className="followBtn"; btn.textContent="è§£é™¤";
    btn.onclick=e=>{
      e.stopPropagation();
      database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{
        let arr=s.val()||[]; arr=arr.filter(id=>id!==user.id);
        database.ref("users/"+currentUser.uid+"/following").set(arr);
      });
    };
    div.appendChild(btn);
  }

  /* DMé·ç§»ï¼ˆç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼ã®ã¿ï¼‰ */
  div.onclick=()=>{
    if(mode==="search") return;
    Promise.all([
      database.ref("users/"+user.id+"/following").once("value"),
      database.ref("users/"+currentUser.uid+"/following").once("value")
    ]).then(([theirSnap,mySnap])=>{
      const their = theirSnap.val()||[];
      const mine = mySnap.val()||[];
      if(their.includes(currentUser.uid) && mine.includes(user.id)){
        location.href="dm.html?opponentId="+user.id;
      } else { alert("ç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼ã®ç›¸æ‰‹ã®ã¿DMã§ãã‚‹ãŒã­ï¼"); }
    });
  };

  return div;
}

/* æ¤œç´¢ */
searchBar.addEventListener("input", ()=>{
  const kw=searchBar.value.trim().toLowerCase();
  if(!kw){ searchResultsDiv.style.display="none"; return; }
  searchResultsDiv.style.display="block"; searchResultsDiv.innerHTML="";
  database.ref("users").once("value").then(s=>{
    const users=s.val()||{};
    for(const uid in users){
      if(uid===currentUser.uid) continue;
      const u=users[uid]; const name=(u.displayName||"").toLowerCase();
      if(name.includes(kw)||uid.includes(kw)){
        searchResultsDiv.appendChild(createUserDiv({id:uid, displayName:u.displayName, photoURL:u.photoURL||"https://via.placeholder.com/40"}, "search"));
      }
    }
  });
});
</script>
</body>
  </html>
