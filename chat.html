<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyChat - ãƒˆãƒ¼ã‚¯ãƒªã‚¹ãƒˆ</title>
<style>
body {
  font-family:sans-serif; padding:20px;
  transition: background 0.3s, color 0.3s;
}
body.dark { background:#1e1e1e; color:#f0f0f0; }

#tabs { display:flex; gap:10px; margin-bottom:10px; }
.tabBtn { padding:5px 10px; cursor:pointer; border:none; border-radius:5px; background:#ccc; }
.tabBtn.active { background:#6200ea; color:white; }

.listContainer { max-width:400px; margin:auto; }
.listContainer div {
  border:1px solid #ccc; padding:10px; margin-bottom:5px;
  cursor:pointer; display:flex; align-items:center; justify-content:space-between;
}
.listContainer img { width:40px; height:40px; border-radius:50%; margin-right:10px; }
.listInfo { display:flex; align-items:center; flex:1; }

.followBtn { padding:5px 8px; cursor:pointer; }

#searchBar { width:300px; padding:5px; margin-bottom:10px; }

#notifyBtn {
  margin-left:10px;
  padding:5px 10px;
  cursor:pointer;
}

/* ğŸ””é€šçŸ¥ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
#notifyPopup {
  position:absolute;
  right:20px;
  top:80px;
  width:260px;
  background:white;
  border:1px solid #ccc;
  padding:10px;
  display:none;
  z-index:1000;
  max-height:300px;
  overflow-y:auto;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<h2>MyChat</h2>

<div id="tabs">
  <button class="tabBtn active" id="tabChats">ãƒãƒ£ãƒƒãƒˆä¸€è¦§</button>
  <button class="tabBtn" id="tabFollows">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§</button>
  <button id="darkToggle">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
</div>

<!-- ğŸ”æ¤œç´¢ãƒãƒ¼ & ğŸ””é€šçŸ¥ãƒœã‚¿ãƒ³ -->
<input type="text" id="searchBar" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢...">
<button id="notifyBtn">ğŸ””</button>

<!-- ğŸ””é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ -->
<div id="notifyPopup"></div>

<!-- æ¤œç´¢çµæœ -->
<div id="searchResults" class="listContainer" style="display:none;"></div>

<!-- ãƒãƒ£ãƒƒãƒˆä¸€è¦§ -->
<div id="chatList" class="listContainer"></div>

<!-- ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§ -->
<div id="followList" class="listContainer" style="display:none;"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const database = firebase.database();

let currentUser=null;
let chatData=[];
let followData=[];
let notifyData=[];
let activeTab="chats";

// DOM
const searchBar=document.getElementById("searchBar");
const searchResultsDiv=document.getElementById("searchResults");
const chatListDiv=document.getElementById("chatList");
const followListDiv=document.getElementById("followList");
const tabChats=document.getElementById("tabChats");
const tabFollows=document.getElementById("tabFollows");
const darkToggle=document.getElementById("darkToggle");
const notifyBtn=document.getElementById("notifyBtn");
const notifyPopup=document.getElementById("notifyPopup");

/* --------------------
  ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
--------------------- */
if(localStorage.getItem("darkMode")==="true") {
  document.body.classList.add("dark");
}
darkToggle.onclick = ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode",
    document.body.classList.contains("dark"));
};

/* --------------------
  ã‚¿ãƒ–åˆ‡æ›¿ï¼ˆãƒ•ã‚©ãƒ­ãƒ¼ã¨ãƒãƒ£ãƒƒãƒˆã‚’åŒæ™‚è¡¨ç¤ºã«å¤‰æ›´ï¼‰
--------------------- */
tabChats.onclick = ()=>{
  tabChats.classList.add("active");
  tabFollows.classList.remove("active");
  searchResultsDiv.style.display='none';
  chatListDiv.style.display='block';
  followListDiv.style.display='block';
};
tabFollows.onclick = tabChats.onclick; // åŒæ™‚è¡¨ç¤ºå›ºå®š

/* --------------------
  Firebaseãƒ­ã‚°ã‚¤ãƒ³å¾Œ
--------------------- */
auth.onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  currentUser=user;

  loadChats();
  loadFollows();
  loadNotifications();  // ğŸ””é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼
});

/* --------------------
  ãƒãƒ£ãƒƒãƒˆä¸€è¦§
--------------------- */
function loadChats(){
  database.ref("chats/"+currentUser.uid+"/list").on("value", snap=>{
    const data=snap.val()||{};
    chatData=[];
    const list=Object.keys(data);

    Promise.all(list.map(uid=>{
      return database.ref("users/"+uid).once("value").then(s=>{
        const u=s.val();
        if(!u) return;
        chatData.push({
          id: uid,
          displayName: u.displayName,
          photoURL: u.photoURL || "https://via.placeholder.com/40",
          lastMessage: data[uid].lastMessage || ""
        });
      });
    })).then(()=> displayChats());
  });
}

function displayChats(){
  chatListDiv.innerHTML="";
  chatData.forEach(u=>{
    chatListDiv.appendChild(createUserDiv(u,"chat"));
  });
}

/* --------------------
  ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§
--------------------- */
function loadFollows(){
  database.ref("users/"+currentUser.uid+"/following").on("value", snap=>{
    const arr=snap.val()||[];
    followData=[];
    Promise.all(arr.map(fid=>{
      return database.ref("users/"+fid).once("value").then(s=>{
        const u=s.val(); if(!u) return;
        followData.push({
          id: fid,
          displayName: u.displayName,
          photoURL: u.photoURL || "https://via.placeholder.com/40"
        });
      });
    })).then(()=> displayFollows());
  });
}

function displayFollows(){
  followListDiv.innerHTML="";
  followData.forEach(u=>{
    followListDiv.appendChild(createUserDiv(u,"follow"));
  });
}

/* --------------------
  é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼
--------------------- */
notifyBtn.onclick = ()=>{
  notifyPopup.style.display =
    (notifyPopup.style.display==="none"||notifyPopup.style.display==="") ? "block" : "none";
};

function loadNotifications(){
  database.ref("notifications/"+currentUser.uid+"/list")
    .limitToLast(10)
    .on("value", snap=>{
      const raw = snap.val() || {};
      notifyData = Object.values(raw).sort((a,b)=> b.time - a.time);
      displayNotifications();
    });
}

function displayNotifications(){
  notifyPopup.innerHTML="";
  if(notifyData.length===0){
    notifyPopup.innerHTML="<div>é€šçŸ¥ã¯ãªã„ãŒã­ã€œ</div>";
    return;
  }

  notifyData.forEach(n=>{
    const div=document.createElement("div");
    div.style.borderBottom="1px solid #ccc";
    div.style.padding="5px";

    div.innerHTML=`
      <div>${n.message}</div>
      <button class="fbBtn" data-id="${n.from}">ãƒ•ã‚©ãƒ­ãƒ¼ãƒãƒƒã‚¯</button>
    `;
    notifyPopup.appendChild(div);
  });

  document.querySelectorAll(".fbBtn").forEach(btn=>{
    btn.onclick = ()=> followBack(btn.dataset.id);
  });
}

/* ãƒ•ã‚©ãƒ­ãƒ¼ãƒãƒƒã‚¯å‡¦ç† */
function followBack(uid){
  database.ref("users/"+currentUser.uid+"/following")
    .once("value").then(s=>{
      let arr=s.val()||[];
      if(!arr.includes(uid)) arr.push(uid);
      database.ref("users/"+currentUser.uid+"/following").set(arr);
    });

  // é€šçŸ¥å‰Šé™¤
  database.ref("notifications/"+currentUser.uid+"/list")
    .once("value").then(s=>{
      const data=s.val()||{};
      for(const key in data){
        if(data[key].from===uid){
          database.ref("notifications/"+currentUser.uid+"/list/"+key).remove();
        }
      }
    });
}

/* --------------------
  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ç”Ÿæˆ
--------------------- */
function createUserDiv(u, mode){
  const div=document.createElement("div");

  const info=document.createElement("div");
  info.className="listInfo";

  const img=document.createElement("img");
  img.src=u.photoURL;
  info.appendChild(img);

  info.appendChild(document.createTextNode(
    u.displayName + (u.lastMessage? ("ï¼š "+u.lastMessage) : "")
  ));

  div.appendChild(info);

  if(mode==="search"){
    const btn=document.createElement("button");
    btn.className="followBtn";
    btn.textContent="ãƒ•ã‚©ãƒ­ãƒ¼";

    btn.onclick = e=>{
      e.stopPropagation();
      followUser(u.id);
    };

    div.appendChild(btn);
  }

  if(mode==="follow"){
    const btn=document.createElement("button");
    btn.className="followBtn";
    btn.textContent="è§£é™¤";

    btn.onclick=e=>{
      e.stopPropagation();
      unfollowUser(u.id);
    };

    div.appendChild(btn);
  }

  div.onclick = ()=> location.href="dm.html?opponentId="+u.id;
  return div;
}

/* ãƒ•ã‚©ãƒ­ãƒ¼å‡¦ç† */
function followUser(targetId){
  database.ref("users/"+currentUser.uid+"/following")
    .once("value").then(s=>{
      let arr=s.val()||[];
      if(!arr.includes(targetId)) arr.push(targetId);
      database.ref("users/"+currentUser.uid+"/following").set(arr);

      pushFollowNotification(targetId);
    });
}

/* ãƒ•ã‚©ãƒ­ãƒ¼è§£é™¤ */
function unfollowUser(targetId){
  database.ref("users/"+currentUser.uid+"/following")
    .once("value").then(s=>{
      let arr=s.val()||[];
      arr = arr.filter(id=>id!==targetId);
      database.ref("users/"+currentUser.uid+"/following").set(arr);
    });
}

/* ãƒ•ã‚©ãƒ­ãƒ¼é€šçŸ¥ã‚’é€ã‚‹ */
function pushFollowNotification(targetId){
  const ref = database.ref("notifications/"+targetId+"/list").push();

  const data = {
    id: ref.key,
    from: currentUser.uid,
    message: currentUser.displayName + " ã•ã‚“ãŒã‚ãªãŸã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸãŒã­ï¼",
    time: Date.now()
  };

  ref.set(data);

  // ğŸ””10ä»¶ä»¥ä¸Šã‚ã£ãŸã‚‰å¤ã„ã®å‰Šé™¤
  database.ref("notifications/"+targetId+"/list")
    .once("value").then(snap=>{
      const list=snap.val()||{};
      const keys=Object.keys(list);
      if(keys.length <= 10) return;

      // æœ€ã‚‚å¤ã„é€šçŸ¥ã‚’æ¢ã™
      let oldestKey=keys[0];
      let oldestTime=list[oldestKey].time;

      keys.forEach(k=>{
        if(list[k].time < oldestTime){
          oldestTime=list[k].time;
          oldestKey=k;
        }
      });

      database.ref("notifications/"+targetId+"/list/"+oldestKey).remove();
    });
}

/* --------------------
  æ¤œç´¢æ©Ÿèƒ½
--------------------- */
searchBar.addEventListener("input", ()=>{
  const kw=searchBar.value.trim().toLowerCase();
  if(!kw){
    searchResultsDiv.style.display='none';
    return;
  }

  searchResultsDiv.style.display='block';
  searchResultsDiv.innerHTML="";

  database.ref("users").once("value").then(snap=>{
    const users=snap.val()||{};
    for(const uid in users){
      if(uid===currentUser.uid) continue;

      const u=users[uid];
      const name=(u.displayName||"").toLowerCase();
      if(name.includes(kw)||uid.includes(kw)){
        searchResultsDiv.appendChild(
          createUserDiv(
            {id:uid, displayName:u.displayName, photoURL:u.photoURL||"https://via.placeholder.com/40"},
            "search"
          )
        );
      }
    }
  });
});
</script>
</body>
</html>
