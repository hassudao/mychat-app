<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyChat - „Éà„Éº„ÇØ„É™„Çπ„Éà</title>

<style>
body {
  font-family:sans-serif;
  padding:20px;
  transition: background 0.3s, color 0.3s;
}
body.dark { background:#1e1e1e; color:#f0f0f0; }

.listContainer { max-width:420px; margin:auto; }

.listItem {
  border:1px solid #ccc;
  padding:10px;
  margin-bottom:5px;
  cursor:pointer;
  display:flex;
  align-items:center;
  background:white;
}
body.dark .listItem { background:#2b2b2b; border-color:#555; }

.userIcon { width:45px; height:45px; border-radius:50%; margin-right:10px; }
.nameBlock { display:flex; flex-direction:column; justify-content:center; flex:1; text-align:left; }
.userName { font-size:15px; font-weight:bold; }
.lastMsg { font-size:14px; margin-top:2px; opacity:0.7; }
.unreadMsg { opacity:1; }

.badge { position:absolute; top:-3px; left:-3px; background:red; color:white; font-size:10px; padding:2px 4px; border-radius:50%; }
.iconWrapper { position:relative; }

.followBtn { padding:5px 8px; cursor:pointer; margin-left:8px; }

#searchBar { width:260px; padding:5px; margin-bottom:10px; }
#darkToggle { padding:5px 10px; margin-bottom:15px; cursor:pointer; }

#notifyBtn { margin-left:10px; padding:5px 10px; cursor:pointer; }
#notifyPopup {
  display:none;
  position:absolute;
  right:20px;
  top:120px;
  width:260px;
  background:white;
  border:1px solid #ccc;
  padding:10px;
  z-index:999;
  max-height:300px;
  overflow-y:auto;
}
body.dark #notifyPopup { background:#2b2b2b; border-color:#555; color:white; }
.notifyItem { border-bottom:1px solid #ccc; padding:8px; }
.fbBtn { margin-top:5px; padding:5px; cursor:pointer; }

/* ===== „Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ ===== */
#profileModal {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  z-index:2000;
  justify-content:center;
  align-items:center;
}
#profileBox {
  background:white;
  padding:20px;
  width:300px;
  border-radius:10px;
}
body.dark #profileBox { background:#2b2b2b; color:white; }

#profileIconPreview {
  width:70px; height:70px;
  border-radius:50%;
  display:block;
  margin:auto;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<script>
/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();
const storage = firebase.storage();

/* DOM */
const openProfileBtn = document.getElementById("openProfile");
const profileModal = document.getElementById("profileModal");
const closeProfileBtn = document.getElementById("closeProfile");
const saveProfileBtn = document.getElementById("saveProfileBtn");
const profileIconPreview = document.getElementById("profileIconPreview");
const profileIconInput = document.getElementById("profileIconInput");
const profileNameInput = document.getElementById("profileNameInput");

let currentUser = null;

/* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
if(localStorage.getItem("darkMode")==="true") document.body.classList.add("dark");
darkToggle.onclick = ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark"));
};

/* „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã */
auth.onAuthStateChanged(async user=>{
  if(!user){ location.href="index.html"; return; }
  currentUser = user;

  await loadProfileInfo();
  loadChats();
  loadFollows();
  loadNotifications();
});

/* ‚ñº„Éó„É≠„Éï„Ç£„Éº„É´Ë™≠„ÅøËæº„Åø */
async function loadProfileInfo(){
  const snap = await database.ref("users/"+currentUser.uid).once("value");
  const u = snap.val() || {};

  profileNameInput.value = u.displayName || currentUser.displayName || "";

  profileIconPreview.src =
    u.photoURL ||
    currentUser.photoURL ||
    "https://via.placeholder.com/70";
}

/* ‚ñº„É¢„Éº„ÉÄ„É´Êìç‰Ωú */
openProfileBtn.onclick = ()=> profileModal.style.display = "flex";
closeProfileBtn.onclick = ()=> profileModal.style.display = "none";

/* ‚ñºÁîªÂÉè„Éó„É¨„Éì„É•„ÉºÔºà„É≠„Éº„Ç´„É´OKÔºâ */
profileIconInput.onchange = ()=>{
  const file = profileIconInput.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = e => profileIconPreview.src = e.target.result;
    reader.readAsDataURL(file);
  }
};

/* ‚ñº„Éó„É≠„Éï„Ç£„Éº„É´‰øùÂ≠ò */
saveProfileBtn.onclick = async ()=>{
  const newName = profileNameInput.value.trim();
  const userRef = database.ref("users/"+currentUser.uid);
  const oldData = (await userRef.once("value")).val() || {};

  let newIconURL = oldData.photoURL || currentUser.photoURL || "";

  /* ‚ñºÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºà‰øÆÊ≠£ÁâàÔºöinput.files[0] „ÅåÊ≠£Â∏∏„Å´Âèñ„Çå„ÇãÔºâ */
  if(profileIconInput.files.length > 0){
    const file = profileIconInput.files[0];
    const ref = storage.ref(`icons/${currentUser.uid}.jpg`);

    await ref.put(file);
    newIconURL = await ref.getDownloadURL();
  }

  /* DBÊõ¥Êñ∞ */
  await userRef.update({
    displayName: newName,
    photoURL: newIconURL
  });

  /* AuthÊõ¥Êñ∞ */
  await currentUser.updateProfile({
    displayName: newName,
    photoURL: newIconURL
  });

  alert("‰øùÂ≠ò„Åß„Åç„Åü„Åß„Çà‚ÄºÔ∏èüî•‚ú®");
  profileModal.style.display = "none";
};

/* ========== ÈÄöÁü•„Çª„É≥„Çø„Éº ========== */
notifyBtn.onclick = ()=>{
  notifyPopup.style.display =
    notifyPopup.style.display === "block" ? "none" : "block";
};

function loadNotifications(){
  database.ref("notifications/"+currentUser.uid+"/list")
    .limitToLast(10)
    .on("value", snap=>{
      const data = snap.val() || {};
      const arr = Object.values(data).sort((a,b)=>b.time - a.time);
      displayNotifications(arr);
    });
}

function displayNotifications(list){
  notifyPopup.innerHTML = "";

  if(list.length === 0){
    notifyPopup.innerHTML = "<div>ÈÄöÁü•„ÅØ„Å™„ÅÑ„Åå„Å≠„Äú</div>";
    return;
  }

  list.forEach(n=>{
    const div = document.createElement("div");
    div.className = "notifyItem";
    div.innerHTML = `
      <div>${n.message}</div>
      <button class="fbBtn" data-id="${n.from}">„Éï„Ç©„É≠„Éº„Éê„ÉÉ„ÇØ</button>
    `;
    notifyPopup.appendChild(div);
  });

  document.querySelectorAll(".fbBtn").forEach(btn=>{
    btn.onclick = e=> followBack(e.target.dataset.id);
  });
}

async function followBack(uid){
  const ref = database.ref("users/"+currentUser.uid+"/following");
  const snap = await ref.once("value");
  let arr = snap.val() || [];

  if(!arr.includes(uid)) arr.push(uid);
  await ref.set(arr);

  /* ÈÄöÁü•ÂâäÈô§ */
  const notiRef = database.ref("notifications/"+currentUser.uid+"/list");
  const notis = (await notiRef.once("value")).val() || {};

  for(const k in notis){
    if(notis[k].from === uid){
      notiRef.child(k).remove();
    }
  }
}

function pushFollowNotification(targetId){
  const ref = database.ref(`notifications/${targetId}/list`).push();

  database.ref("users/"+currentUser.uid).once("value").then(s=>{
    const me = s.val() || {};

    ref.set({
      id: ref.key,
      from: currentUser.uid,
      message: `${me.displayName || "ÂêçÁÑ°„Åó"} „Åï„Çì„Åå„ÅÇ„Å™„Åü„Çí„Éï„Ç©„É≠„Éº„Åó„Åü„Åå„Å≠‚ÄºÔ∏èüî•`,
      time: Date.now()
    });
  });
}

/* ========== „ÉÅ„É£„ÉÉ„Éà‰∏ÄË¶ß ========== */
function loadChats(){
  database.ref("chats/"+currentUser.uid+"/list")
  .on("value", snap=>{
    const data = snap.val() || {};
    const arr = [];
    const tasks = [];

    for(const uid in data){
      tasks.push(
        database.ref("users/"+uid).once("value").then(us=>{
          const u = us.val();
          if(!u){
            database.ref("chats/"+currentUser.uid+"/list/"+uid).remove();
            return;
          }
          arr.push({
            id: uid,
            displayName: u.displayName,
            photoURL: u.photoURL || "https://via.placeholder.com/40",
            lastMessage: data[uid].lastMessage || "",
            unread: data[uid].unread || 0
          });
        })
      );
    }

    Promise.all(tasks).then(()=> displayChats(arr));
  });
}

function displayChats(list){
  chatList.innerHTML = "";
  list.forEach(u=>{
    chatList.appendChild(createUserDiv(u, "chat"));
  });
}

/* ========== „Éï„Ç©„É≠„Éº‰∏ÄË¶ß ========== */
function loadFollows(){
  database.ref("users/"+currentUser.uid+"/following")
  .on("value", snap=>{
    const arr = snap.val() || [];
    const out = [];
    const tasks = [];

    arr.forEach(uid=>{
      tasks.push(
        database.ref("users/"+uid).once("value").then(us=>{
          const u = us.val(); if(!u) return;
          out.push({
            id: uid,
            displayName: u.displayName,
            photoURL: u.photoURL || "https://via.placeholder.com/40"
          });
        })
      );
    });

    Promise.all(tasks).then(()=> displayFollows(out));
  });
}

function displayFollows(list){
  followList.innerHTML = "";
  list.forEach(u=>{
    followList.appendChild(createUserDiv(u, "follow"));
  });
}

/* ========== ÂÖ±ÈÄö„É¶„Éº„Ç∂„ÉºË°®Á§∫ÁîüÊàê ========== */
function createUserDiv(user, mode){
  const div = document.createElement("div");
  div.className = "listItem";

  const iconWrapper = document.createElement("div");
  iconWrapper.className = "iconWrapper";

  const img = document.createElement("img");
  img.className ="userIcon";
  img.src = user.photoURL;
  iconWrapper.appendChild(img);

  /* Êú™Ë™≠„Éê„ÉÉ„Ç∏ */
  if(user.unread > 0){
    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = user.unread;
    iconWrapper.appendChild(badge);
  }

  const info = document.createElement("div");
  info.className = "nameBlock";

  const name = document.createElement("div");
  name.className = "userName";
  name.textContent = user.displayName;
  info.appendChild(name);

  if(user.lastMessage !== undefined){
    const msg = document.createElement("div");
    msg.className = "lastMsg";
    msg.textContent = user.lastMessage;
    if(user.unread > 0) msg.classList.add("unreadMsg");
    info.appendChild(msg);
  }

  div.appendChild(iconWrapper);
  div.appendChild(info);

  /* ‚ñºÊ§úÁ¥¢Ê¨Ñ„ÅÆ„Éï„Ç©„É≠„Éº„Éú„Çø„É≥ */
  if(mode === "search"){
    const btn = document.createElement("button");
    btn.className = "followBtn";

    database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{
      const arr = s.val() || [];
      btn.textContent = arr.includes(user.id) ? "„Éï„Ç©„É≠„Éº‰∏≠" : "„Éï„Ç©„É≠„Éº";
    });

    btn.onclick = e=>{
      e.stopPropagation();

      database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{
        let arr = s.val() || [];

        if(arr.includes(user.id)){
          arr = arr.filter(v=>v !== user.id);
          btn.textContent = "„Éï„Ç©„É≠„Éº";
        } else {
          arr.push(user.id);
          btn.textContent = "„Éï„Ç©„É≠„Éº‰∏≠";
          pushFollowNotification(user.id);
        }

        database.ref("users/"+currentUser.uid+"/following").set(arr);
      });
    };

    div.appendChild(btn);
  }

  /* ‚ñº„Éï„Ç©„É≠„Éº‰∏ÄË¶ß„ÅÆËß£Èô§„Éú„Çø„É≥ */
  if(mode === "follow"){
    const btn = document.createElement("button");
    btn.className = "followBtn";
    btn.textContent = "Ëß£Èô§";

    btn.onclick = e=>{
      e.stopPropagation();

      database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{
        let arr = s.val() || [];
        arr = arr.filter(id=>id !== user.id);

        database.ref("users/"+currentUser.uid+"/following").set(arr);
      });
    };

    div.appendChild(btn);
  }

  /* ‚ñºDM ÈÅ∑ÁßªÔºàÁõ∏‰∫í„Éï„Ç©„É≠„ÉºÂøÖË¶ÅÔºâ */
  div.onclick = ()=>{
    if(mode === "search") return;

    Promise.all([
      database.ref("users/"+user.id+"/following").once("value"),
      database.ref("users/"+currentUser.uid+"/following").once("value")
    ]).then(([theirSnap,mySnap])=>{
      const their = theirSnap.val() || [];
      const mine = mySnap.val() || [];

      if(their.includes(currentUser.uid) && mine.includes(user.id)){
        location.href = "dm.html?opponentId=" + user.id;
      } else {
        alert("Áõ∏‰∫í„Éï„Ç©„É≠„Éº„Åò„ÇÉ„Å™„ÅÑ„Å®DM„Åß„Åç„Çì„Åå„Å≠‚ÄºÔ∏èüò≠");
      }
    });
  };

  return div;
}

/* ========== Ê§úÁ¥¢ ========== */
searchBar.addEventListener("input", ()=>{
  const kw = searchBar.value.trim().toLowerCase();

  if(!kw){
    searchResults.style.display = "none";
    return;
  }

  searchResults.style.display = "block";
  searchResults.innerHTML = "";

  database.ref("users").once("value").then(s=>{
    const users = s.val() || {};

    for(const uid in users){
      if(uid === currentUser.uid) continue;

      const u = users[uid];
      const name = (u.displayName || "").toLowerCase();

      if(name.includes(kw) || uid.includes(kw)){
        searchResults.appendChild(
          createUserDiv(
            {
              id: uid,
              displayName: u.displayName,
              photoURL: u.photoURL || "https://via.placeholder.com/40"
            },
            "search"
          )
        );
      }
    }
  });
});
  </script>
