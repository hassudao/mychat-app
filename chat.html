<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MyChat Discordé¢¨</title>
  <style>
    body { font-family:sans-serif; text-align:center; padding:20px; }
    body.dark { background-color:#1e1e1e; color:#f0f0f0; }
    #messages { height:400px; overflow-y:scroll; border:1px solid #ccc; margin:10px auto; width:400px; padding:10px; text-align:left; }
    .message { display:flex; align-items:flex-start; margin-bottom:6px; }
    .avatar { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; margin-right:8px; flex-shrink:0; }
    .content { background:#f0f0f0; padding:6px 10px; border-radius:12px; max-width:300px; word-wrap:break-word; }
    body.dark .content { background:#333; color:#fff; }
    #msgInput { width:200px; padding:5px; }
    button { padding:5px 10px; margin:4px; }
    #topButtons { margin-bottom:10px; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h2>
  <div id="topButtons">
    <button id="modeToggle">ğŸŒ™ / â˜€ï¸ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
    <button id="settingsBtn">âš™ï¸ è¨­å®š</button>
  </div>

  <div id="messages"></div>
  <input type="text" id="msgInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›â€¦">
  <button id="sendBtn">é€ä¿¡ï¼</button>

  <script>
    // -----------------------------
    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    // -----------------------------
    const toggleButton = document.getElementById("modeToggle");
    const body = document.body;
    toggleButton.addEventListener("click", ()=>{
      body.classList.toggle("dark");
      localStorage.setItem("mode", body.classList.contains("dark") ? "dark" : "light");
    });
    window.addEventListener("load", ()=>{
      if(localStorage.getItem("mode")==="dark") body.classList.add("dark");
    });

    // -----------------------------
    // è¨­å®šãƒœã‚¿ãƒ³
    // -----------------------------
    const settingsBtn = document.getElementById("settingsBtn");
    settingsBtn.addEventListener("click", ()=>location.href="settings.html");

    // -----------------------------
    // Firebase åˆæœŸåŒ–
    // -----------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
      authDomain: "chatapp-hassu.firebaseapp.com",
      databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chatapp-hassu",
      storageBucket: "chatapp-hassu.appspot.com",
      messagingSenderId: "8489684752",
      appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // -----------------------------
    // HTMLè¦ç´ 
    // -----------------------------
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    // -----------------------------
    // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    // -----------------------------
    auth.onAuthStateChanged(user=>{
      if(!user) location.href = "index.html";
    });

    // -----------------------------
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    // -----------------------------
    sendBtn.addEventListener("click", sendMessage);
    msgInput.addEventListener("keypress", e=>{ if(e.key==="Enter") sendMessage(); });

    function sendMessage(){
      const user = auth.currentUser;
      if(!user) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã¾ã›ã‚“");
      const content = msgInput.value.trim();
      if(!content) return;
      database.ref("messages").push({
        username: user.displayName || "åç„¡ã—",
        photoURL: user.photoURL || "",
        content: content,
        timestamp: Date.now()
      });
      msgInput.value = "";
    }

    // -----------------------------
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
    // -----------------------------
    database.ref("messages").on("value", snapshot=>{
      messagesDiv.innerHTML = "";
      const data = snapshot.val();
      if(data){
        Object.values(data).sort((a,b)=>a.timestamp-b.timestamp).forEach(m=>{
          const div = document.createElement("div");
          div.classList.add("message");

          const avatarDiv = document.createElement("div");
          avatarDiv.classList.add("avatar");
          if(m.photoURL){
            const img = document.createElement("img");
            img.src = m.photoURL;
            img.style.width = "32px";
            img.style.height = "32px";
            img.style.borderRadius = "50%";
            avatarDiv.appendChild(img);
          } else {
            avatarDiv.textContent = m.username[0].toUpperCase();
            avatarDiv.style.backgroundColor = "#666";
            avatarDiv.style.color = "#fff";
            avatarDiv.style.display = "flex";
            avatarDiv.style.alignItems = "center";
            avatarDiv.style.justifyContent = "center";
          }

          const contentDiv = document.createElement("div");
          contentDiv.classList.add("content");
          contentDiv.textContent = m.username + ": " + m.content;

          div.appendChild(avatarDiv);
          div.appendChild(contentDiv);
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    });
  </script>
</body>
  </html>
