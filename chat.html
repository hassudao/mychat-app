<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MyChat Discordé¢¨</title>
  <style>
    body { font-family:sans-serif; text-align:center; padding:20px; }
    body.dark { background-color:#1e1e1e; color:#f0f0f0; }

    #messages { height:400px; overflow-y:scroll; border:1px solid #ccc; margin:10px auto; width:400px; padding:10px; text-align:left; }
    .message { display:flex; align-items:flex-start; margin-bottom:6px; }
    .avatar {
      width:32px; height:32px; border-radius:50%; background:#666; color:#fff; display:flex;
      align-items:center; justify-content:center; font-weight:bold; margin-right:8px; flex-shrink:0;
    }
    .content { background:#f0f0f0; padding:6px 10px; border-radius:12px; max-width:300px; word-wrap:break-word; }
    body.dark .content { background:#333; color:#fff; }

    #msgInput { width:200px; padding:5px; }
    button { padding:5px 10px; margin:4px; }

    #usernamePrompt { margin-bottom:10px; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h2>
  <button id="modeToggle">ğŸŒ™ / â˜€ï¸ ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
  <div id="usernamePrompt">
    <input type="text" id="usernameInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›">
    <button id="setUsernameBtn">æ±ºå®š</button>
  </div>
  <div id="messages"></div>
  <input type="text" id="msgInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›â€¦">
  <button id="sendBtn">é€ä¿¡ï¼</button>

  <script>
    // -----------------------------
    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    // -----------------------------
    const toggleButton = document.getElementById("modeToggle");
    const body = document.body;
    toggleButton.addEventListener("click", ()=>{
      body.classList.toggle("dark");
      localStorage.setItem("mode", body.classList.contains("dark") ? "dark" : "light");
    });
    window.addEventListener("load", ()=>{
      if(localStorage.getItem("mode")==="dark") body.classList.add("dark");
    });

    // -----------------------------
    // Firebase åˆæœŸåŒ–
    // -----------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
      authDomain: "chatapp-hassu.firebaseapp.com",
      databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chatapp-hassu",
      storageBucket: "chatapp-hassu.firebasestorage.app",
      messagingSenderId: "8489684752",
      appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // -----------------------------
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¨­å®š
    // -----------------------------
    let username = localStorage.getItem("username") || "";
    const usernameInput = document.getElementById("usernameInput");
    const setUsernameBtn = document.getElementById("setUsernameBtn");
    const usernamePrompt = document.getElementById("usernamePrompt");

    if(username){
      usernamePrompt.style.display = "none";
    }

    setUsernameBtn.addEventListener("click", ()=>{
      const val = usernameInput.value.trim();
      if(!val) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ã­");
      username = val;
      localStorage.setItem("username", username);
      usernamePrompt.style.display = "none";
    });

    // -----------------------------
    // HTMLè¦ç´ 
    // -----------------------------
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    // -----------------------------
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    // -----------------------------
    sendBtn.addEventListener("click", sendMessage);
    msgInput.addEventListener("keypress", e=>{ if(e.key==="Enter") sendMessage(); });

    function sendMessage(){
      if(!username) return alert("ã¾ãšãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¨­å®šã—ã¦ã­");
      const content = msgInput.value.trim();
      if(!content) return;
      database.ref("messages").push({
        username: username,
        content: content,
        timestamp: Date.now()
      });
      msgInput.value = "";
    }

    // -----------------------------
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
    // -----------------------------
    database.ref("messages").on("value", snapshot=>{
      messagesDiv.innerHTML = "";
      const data = snapshot.val();
      if(data){
        Object.values(data).sort((a,b)=>a.timestamp-b.timestamp).forEach(m=>{
          const div = document.createElement("div");
          div.classList.add("message");

          const avatarDiv = document.createElement("div");
          avatarDiv.classList.add("avatar");
          avatarDiv.textContent = m.username[0].toUpperCase();
          div.appendChild(avatarDiv);

          const contentDiv = document.createElement("div");
          contentDiv.classList.add("content");
          contentDiv.textContent = m.username + ": " + m.content;
          div.appendChild(contentDiv);

          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    });
  </script>
</body>
</html>
