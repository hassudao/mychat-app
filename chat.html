<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyChat - ãƒˆãƒ¼ã‚¯ãƒªã‚¹ãƒˆ</title>

<style>
body {
  font-family:sans-serif;
  padding:20px;
  transition: background 0.3s, color 0.3s;
}
body.dark { background:#1e1e1e; color:#f0f0f0; }

.listContainer {
  max-width:420px;
  margin:auto;
}

/* å„è¡Œã®ç®± */
.listItem {
  border:1px solid #ccc;
  padding:10px;
  margin-bottom:5px;
  cursor:pointer;
  display:flex;
  align-items:center;
  background:white;
}
body.dark .listItem {
  background:#2b2b2b;
  border-color:#555;
}

/* ã‚¢ã‚¤ã‚³ãƒ³ï¼‹åå‰ï¼‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.userIcon {
  width:45px;
  height:45px;
  border-radius:50%;
  margin-right:10px;
}

.nameBlock {
  display:flex;
  flex-direction:column;
  justify-content:center;
  flex:1;
  text-align:left;
}

/* åå‰ï¼ˆä¸Šï¼‰ */
.userName {
  font-size:15px;
  font-weight:bold;
}

/* æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä¸‹ï¼‰ */
.lastMsg {
  font-size:14px;
  margin-top:2px;
  opacity:0.7;
}

/* æœªèª­ â†’ æ¿ƒã„è‰² */
.unreadMsg {
  opacity:1;
}

/* ãƒãƒƒã‚¸ï¼ˆæœªèª­æ•°ï¼‰ */
.badge {
  position:absolute;
  top:-3px;
  left:-3px;
  background:red;
  color:white;
  font-size:10px;
  padding:2px 4px;
  border-radius:50%;
}

/* DMã‚¢ã‚¤ã‚³ãƒ³ã‚¨ãƒªã‚¢ */
.iconWrapper {
  position:relative;
}

/* ãƒ•ã‚©ãƒ­ãƒ¼ç³»ãƒœã‚¿ãƒ³ */
.followBtn {
  padding:5px 8px;
  cursor:pointer;
  margin-left:8px;
}

/* æ¤œç´¢ãƒãƒ¼ */
#searchBar {
  width:260px;
  padding:5px;
  margin-bottom:10px;
}

#darkToggle {
  padding:5px 10px;
  margin-bottom:15px;
  cursor:pointer;
}

/* é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ */
#notifyBtn {
  margin-left:10px;
  padding:5px 10px;
  cursor:pointer;
}
#notifyPopup {
  display:none;
  position:absolute;
  right:20px;
  top:120px;
  width:260px;
  background:white;
  border:1px solid #ccc;
  padding:10px;
  z-index:999;
  max-height:300px;
  overflow-y:auto;
}
body.dark #notifyPopup {
  background:#2b2b2b;
  border-color:#555;
  color:white;
}

.notifyItem {
  border-bottom:1px solid #ccc;
  padding:8px;
}
.fbBtn {
  margin-top:5px;
  padding:5px;
  cursor:pointer;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>

<h2>MyChat</h2>

<button id="darkToggle">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>

<!-- æ¤œç´¢ãƒãƒ¼ + é€šçŸ¥ãƒœã‚¿ãƒ³ -->
<input type="text" id="searchBar" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢...">
<button id="notifyBtn">ğŸ””</button>

<!-- é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ -->
<div id="notifyPopup"></div>

<!-- æ¤œç´¢çµæœ -->
<div id="searchResults" class="listContainer" style="display:none;"></div>

<h3>ãƒãƒ£ãƒƒãƒˆä¸€è¦§</h3>
<div id="chatList" class="listContainer"></div>

<h3>ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§</h3>
<div id="followList" class="listContainer"></div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const database = firebase.database();

/* DOM */
const searchBar = document.getElementById("searchBar");
const searchResultsDiv = document.getElementById("searchResults");
const chatListDiv = document.getElementById("chatList");
const followListDiv = document.getElementById("followList");
const notifyBtn = document.getElementById("notifyBtn");
const notifyPopup = document.getElementById("notifyPopup");

let currentUser=null;

/* é€šçŸ¥ãƒˆã‚°ãƒ« */
notifyBtn.onclick = () => {
  notifyPopup.style.display =
    notifyPopup.style.display === "none" || notifyPopup.style.display === ""
    ? "block" : "none";
};

/* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
if(localStorage.getItem("darkMode")==="true"){
  document.body.classList.add("dark");
}
darkToggle.onclick = ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode", document.body.classList.contains("dark"));
};

/* ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ */
auth.onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  currentUser=user;

  loadChats();
  loadFollows();
  loadNotifications();
});

/* -----------------------------
   é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼
----------------------------- */
function loadNotifications(){
  database.ref("notifications/"+currentUser.uid+"/list")
    .limitToLast(10)
    .on("value", snap=>{
      const data=snap.val()||{};
      const arr=Object.values(data).sort((a,b)=>b.time-a.time);
      displayNotifications(arr);
    });
}

function displayNotifications(list){
  notifyPopup.innerHTML="";
  if(list.length===0){
    notifyPopup.innerHTML="<div>é€šçŸ¥ã¯ãªã„ãŒã­ã€œ</div>";
    return;
  }

  list.forEach(n=>{
    const div=document.createElement("div");
    div.className="notifyItem";
    div.innerHTML=`
      <div>${n.message}</div>
      <button class="fbBtn" data-id="${n.from}">ãƒ•ã‚©ãƒ­ãƒ¼ãƒãƒƒã‚¯</button>
    `;
    notifyPopup.appendChild(div);
  });

  document.querySelectorAll(".fbBtn").forEach(btn=>{
    btn.onclick=e=>{
      const uid=e.target.dataset.id;
      followBack(uid);
    };
  });
}

function followBack(uid){
  database.ref("users/"+currentUser.uid+"/following")
    .once("value").then(s=>{
      let arr=s.val()||[];
      if(!arr.includes(uid)) arr.push(uid);
      database.ref("users/"+currentUser.uid+"/following").set(arr);
    });

  database.ref("notifications/"+currentUser.uid+"/list")
    .once("value").then(s=>{
      const data=s.val()||{};
      for(const k in data){
        if(data[k].from===uid){
          database.ref("notifications/"+currentUser.uid+"/list/"+k).remove();
        }
      }
    });
}

function pushFollowNotification(targetId){
  const ref=database.ref("notifications/"+targetId+"/list").push();
  const d={
    id:ref.key,
    from:currentUser.uid,
    message:`${currentUser.displayName} ã•ã‚“ãŒã‚ãªãŸã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ãŸãŒã­ï¼`,
    time:Date.now()
  };
  ref.set(d);

  database.ref("notifications/"+targetId+"/list")
    .once("value").then(s=>{
      const list=s.val()||{};
      const keys=Object.keys(list);
      if(keys.length>10){
        let oldest=keys[0];
        let ot=list[oldest].time;

        keys.forEach(k=>{
          if(list[k].time<ot){
            oldest=k;
            ot=list[k].time;
          }
        });

        database.ref("notifications/"+targetId+"/list/"+oldest).remove();
      }
    });
}

/* -----------------------------
   ãƒãƒ£ãƒƒãƒˆä¸€è¦§
----------------------------- */
function loadChats(){
  database.ref("chats/"+currentUser.uid+"/list")
    .on("value", snap=>{
      const data=snap.val()||{};
      const arr=[];
      const tasks=[];
      for(const uid in data){
        tasks.push(
          database.ref("users/"+uid).once("value").then(us=>{
            const u=us.val();
            if(!u){
              database.ref("chats/"+currentUser.uid+"/list/"+uid).remove();
              return;
            }
            arr.push({
              id:uid,
              displayName:u.displayName,
              photoURL:u.photoURL || "https://via.placeholder.com/40",
              lastMessage:data[uid].lastMessage || "",
              unread:data[uid].unread || 0
            });
          })
        );
      }
      Promise.all(tasks).then(()=>displayChats(arr));
    });
}

function displayChats(list){
  chatListDiv.innerHTML="";
  list.forEach(u=>{
    chatListDiv.appendChild(createUserDiv(u,"chat"));
  });
}

/* -----------------------------
   ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ä¸€è¦§
----------------------------- */
function loadFollows(){
  database.ref("users/"+currentUser.uid+"/following")
    .on("value", snap=>{
      const arr=snap.val()||[];
      const out=[];
      const tasks=[];

      arr.forEach(uid=>{
        tasks.push(
          database.ref("users/"+uid).once("value").then(us=>{
            const u=us.val();
            if(!u) return;
            out.push({
              id:uid,
              displayName:u.displayName,
              photoURL:u.photoURL || "https://via.placeholder.com/40"
            });
          })
        );
      });

      Promise.all(tasks).then(()=>displayFollows(out));
    });
}

function displayFollows(list){
  followListDiv.innerHTML="";
  list.forEach(u=>{
    followListDiv.appendChild(createUserDiv(u,"follow"));
  });
}

/* -----------------------------
   å…±é€šãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œç”Ÿæˆ
----------------------------- */
function createUserDiv(user, mode){
  const div=document.createElement("div");
  div.className="listItem";

  /* ã‚¢ã‚¤ã‚³ãƒ³ï¼‹æœªèª­ãƒãƒƒã‚¸ */
  const iconWrapper=document.createElement("div");
  iconWrapper.className="iconWrapper";

  const img=document.createElement("img");
  img.className="userIcon";
  img.src=user.photoURL;
  iconWrapper.appendChild(img);

  if(user.unread > 0){
    const badge=document.createElement("div");
    badge.className="badge";
    badge.textContent=user.unread;
    iconWrapper.appendChild(badge);
  }

  const nameBlock=document.createElement("div");
  nameBlock.className="nameBlock";

  const name=document.createElement("div");
  name.className="userName";
  name.textContent=user.displayName;
  nameBlock.appendChild(name);

  if(user.lastMessage!==undefined){
    const msg=document.createElement("div");
    msg.className="lastMsg";
    msg.textContent=user.lastMessage;

    if(user.unread>0) msg.classList.add("unreadMsg");

    nameBlock.appendChild(msg);
  }

  div.appendChild(iconWrapper);
  div.appendChild(nameBlock);

  /* ------ ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆæ¤œç´¢ï¼‰ ------ */
  if(mode==="search"){
    const btn=document.createElement("button");
    btn.className="followBtn";

    database.ref("users/"+currentUser.uid+"/following")
      .once("value").then(s=>{
        const arr=s.val()||[];
        btn.textContent = arr.includes(user.id) ? "ãƒ•ã‚©ãƒ­ãƒ¼ä¸­" : "ãƒ•ã‚©ãƒ­ãƒ¼";
      });

    btn.onclick=(e)=>{
      e.stopPropagation();

      database.ref("users/"+currentUser.uid+"/following")
        .once("value").then(s=>{
          let arr=s.val()||[];

          if(arr.includes(user.id)){
            arr=arr.filter(v=>v!==user.id);
            btn.textContent="ãƒ•ã‚©ãƒ­ãƒ¼";
          }else{
            arr.push(user.id);
            btn.textContent="ãƒ•ã‚©ãƒ­ãƒ¼ä¸­";
            pushFollowNotification(user.id);
          }

          database.ref("users/"+currentUser.uid+"/following").set(arr);
        });
    };

    div.appendChild(btn);
  }

  /* ------ ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ï¼ˆè§£é™¤ãƒœã‚¿ãƒ³ï¼‰ ------ */
  if(mode==="follow"){
    const btn=document.createElement("button");
    btn.className="followBtn";
    btn.textContent="è§£é™¤";

    btn.onclick=(e)=>{
      e.stopPropagation();
      database.ref("users/"+currentUser.uid+"/following")
        .once("value").then(s=>{
          let arr=s.val()||[];
          arr=arr.filter(id=>id!==user.id);
          database.ref("users/"+currentUser.uid+"/following").set(arr);
        });
    };

    div.appendChild(btn);
  }

  /* ------ DMé·ç§»ï¼ˆç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼ã®ã¿ï¼‰ ------ */
  div.onclick=()=>{
    if(mode==="search") return;

    database.ref("users/"+user.id+"/following")
      .once("value").then(s=>{
        const their=s.val()||[];
        if(their.includes(currentUser.uid)){
          location.href="dm.html?opponentId="+user.id;
        }else{
          alert("ç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼ã®ç›¸æ‰‹ã®ã¿DMã§ãã‚‹ãŒã­ï¼");
        }
      });
  };

  return div;
}

/* -----------------------------
   æ¤œç´¢
----------------------------- */
searchBar.addEventListener("input",()=>{
  const kw=searchBar.value.trim().toLowerCase();

  if(!kw){
    searchResultsDiv.style.display="none";
    return;
  }
  searchResultsDiv.style.display="block";
  searchResultsDiv.innerHTML="";

  database.ref("users").once("value").then(s=>{
    const users=s.val()||{};
    for(const uid in users){
      if(uid===currentUser.uid) continue;
      const u=users[uid];
      const name=(u.displayName||"").toLowerCase();

      if(name.includes(kw) || uid.includes(kw)){
        searchResultsDiv.appendChild(
          createUserDiv({
            id:uid,
            displayName:u.displayName,
            photoURL:u.photoURL || "https://via.placeholder.com/40"
          },"search")
        );
      }
    }
  });
});
</script>

</body>
</html>
