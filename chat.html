<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyChat - „Éà„Éº„ÇØ„É™„Çπ„Éà</title>
<style>
body {
  font-family:sans-serif; padding:20px;
  transition: background 0.3s, color 0.3s;
}
body.dark { background:#1e1e1e; color:#f0f0f0; }

#tabs { display:flex; gap:10px; margin-bottom:10px; }
.tabBtn { padding:5px 10px; cursor:pointer; border:none; border-radius:5px; background:#ccc; }
.tabBtn.active { background:#6200ea; color:white; }

.listContainer { max-width:400px; margin:auto; }
.listContainer div {
  border:1px solid #ccc; padding:10px; margin-bottom:5px;
  cursor:pointer; display:flex; align-items:center; justify-content:space-between;
}
.listContainer img { width:40px; height:40px; border-radius:50%; margin-right:10px; }
.listInfo { display:flex; align-items:center; flex:1; }

.followBtn { padding:5px 8px; cursor:pointer; }

#searchBar { width:300px; padding:5px; margin-bottom:10px; }
#darkToggle { padding:5px 10px; margin-left:10px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<h2>MyChat</h2>

<div id="tabs">
  <button class="tabBtn active" id="tabChats">„ÉÅ„É£„ÉÉ„Éà‰∏ÄË¶ß</button>
  <button class="tabBtn" id="tabFollows">„Éï„Ç©„É≠„Éº‰∏≠‰∏ÄË¶ß</button>
  <button id="darkToggle">„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂàáÊõø</button>
</div>

<input type="text" id="searchBar" placeholder="„É¶„Éº„Ç∂„Éº„ÇíÊ§úÁ¥¢...">

<div id="searchResults" class="listContainer" style="display:none;"></div>
<div id="chatList" class="listContainer"></div>
<div id="followList" class="listContainer" style="display:none;"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const database = firebase.database();

const searchBar = document.getElementById("searchBar");
const tabChats = document.getElementById("tabChats");
const tabFollows = document.getElementById("tabFollows");
const darkToggle = document.getElementById("darkToggle");

const searchResultsDiv = document.getElementById("searchResults");
const chatListDiv = document.getElementById("chatList");
const followListDiv = document.getElementById("followList");

let currentUser=null;
let chatData=[];
let followData=[];
let activeTab="chats";

/* -------------------- „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ --------------------- */
if(localStorage.getItem("darkMode")==="true") {
  document.body.classList.add("dark");
}
darkToggle.onclick = ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("darkMode",
    document.body.classList.contains("dark"));
};

/* -------------------- „Çø„ÉñÂàáÊõø --------------------- */
tabChats.onclick = ()=>{
  activeTab='chats';
  tabChats.classList.add("active");
  tabFollows.classList.remove("active");
  searchResultsDiv.style.display='none';
  followListDiv.style.display='none';
  chatListDiv.style.display='block';
};

tabFollows.onclick = ()=>{
  activeTab='follows';
  tabFollows.classList.add("active");
  tabChats.classList.remove("active");
  searchResultsDiv.style.display='none';
  chatListDiv.style.display='none';
  followListDiv.style.display='block';
};

auth.onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  currentUser=user;
  loadChats();
  loadFollows();
});

/* -------------------- „ÉÅ„É£„ÉÉ„Éà‰∏ÄË¶ß --------------------- */
function loadChats(){
  database.ref("chats/"+currentUser.uid+"/list").on("value", snap=>{
    const data = snap.val() || {};
    chatData = [];
    const promises=[];
    for(const uid in data){
      promises.push(
        database.ref("users/"+uid).once("value").then(uSnap=>{
          const u=uSnap.val();
          if(!u){
            database.ref("chats/"+currentUser.uid+"/list/"+uid).remove();
            return;
          }
          chatData.push({
            id: uid,
            lastMessage: data[uid].lastMessage || "",
            displayName: u.displayName || uid,
            photoURL: u.photoURL || "https://via.placeholder.com/40"
          });
        })
      );
    }
    Promise.all(promises).then(()=>{
      if(activeTab==='chats') displayChats();
    });
  });
}

/* -------------------- „Éï„Ç©„É≠„Éº‰∏ÄË¶ß --------------------- */
function loadFollows(){
  database.ref("users/"+currentUser.uid+"/following").on("value", snap=>{
    const arr = snap.val() || [];
    followData=[];
    const promises=[];

    arr.forEach(fid=>{
      promises.push(
        database.ref("users/"+fid).once("value").then(uSnap=>{
          const u=uSnap.val();
          if(!u) return;
          followData.push({
            id: fid,
            displayName: u.displayName,
            photoURL: u.photoURL || "https://via.placeholder.com/40"
          });
        })
      );
    });

    Promise.all(promises).then(()=>{
      if(activeTab==='follows') displayFollows();
    });
  });
}

/* -------------------- „É¶„Éº„Ç∂„ÉºDIVÁîüÊàêÔºàÁµ±ÂêàÁâàÔºâ --------------------- */
function createUserDiv(user, mode){
  const div=document.createElement("div");

  const info=document.createElement("div");
  info.className="listInfo";

  const img=document.createElement("img");
  img.src=user.photoURL;
  info.appendChild(img);
  info.appendChild(document.createTextNode(user.displayName + (user.lastMessage? "Ôºö "+user.lastMessage : "")));
  div.appendChild(info);

  /* „Éï„Ç©„É≠„Éº„Éú„Çø„É≥ÔºàÊ§úÁ¥¢ & „Éï„Ç©„É≠„Éº‰∏ÄË¶ß„ÅÆÂÖ±ÈÄöÂá¶ÁêÜÔºâ */
  if(mode==="search" || mode==="follow"){
    const btn=document.createElement("button");
    btn.className="followBtn";

    // ÂàùÊúüË°®Á§∫
    database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{
      let arr=s.val()||[];
      btn.textContent = arr.includes(user.id) ? "„Éï„Ç©„É≠„Éº‰∏≠" : "„Éï„Ç©„É≠„Éº";
    });

    btn.onclick=(e)=>{
      e.stopPropagation();
      database.ref("users/"+currentUser.uid+"/following").once("value").then(s=>{
        let arr=s.val()||[];

        if(arr.includes(user.id)){
          arr = arr.filter(id=>id !== user.id);
          btn.textContent="„Éï„Ç©„É≠„Éº";
        }else{
          arr.push(user.id);
          btn.textContent="„Éï„Ç©„É≠„Éº‰∏≠";
        }

        database.ref("users/"+currentUser.uid+"/following").set(arr);
      });
    };

    div.appendChild(btn);
  }

  /* DM„Å∏ÈÅ∑ÁßªÔºàÁõ∏‰∫í„Éï„Ç©„É≠„ÉºÂøÖÈ†àÔºâ */
  div.onclick = ()=>{
    if(mode==="chat"){
      location.href = "dm.html?opponentId="+user.id;
      return;
    }

    Promise.all([
      database.ref("users/"+currentUser.uid+"/following").once("value"),
      database.ref("users/"+user.id+"/following").once("value")
    ]).then(([mine, theirs])=>{
      const meF = mine.val()||[];
      const theyF = theirs.val()||[];

      if(meF.includes(user.id) && theyF.includes(currentUser.uid)){
        location.href = "dm.html?opponentId="+user.id;
      } else {
        alert("Áõ∏‰∫í„Éï„Ç©„É≠„Éº„ÅÆÁõ∏Êâã„Å†„ÅëDM„Åß„Åç„Çã„Åß„ÇàÔºÅüò§üî•");
      }
    });
  };

  return div;
}

/* -------------------- Ë°®Á§∫Âá¶ÁêÜ --------------------- */
function displayChats(){
  chatListDiv.innerHTML="";
  chatData.forEach(u=>{
    chatListDiv.appendChild(createUserDiv(u, "chat"));
  });
}

function displayFollows(){
  followListDiv.innerHTML="";
  followData.forEach(u=>{
    followListDiv.appendChild(createUserDiv(u, "follow"));
  });
}

/* -------------------- Ê§úÁ¥¢Ê©üËÉΩ --------------------- */
searchBar.addEventListener("input", ()=>{
  const kw=searchBar.value.trim().toLowerCase();
  if(!kw){
    searchResultsDiv.style.display='none';
    return;
  }

  searchResultsDiv.style.display='block';
  searchResultsDiv.innerHTML="";

  database.ref("users").once("value").then(snap=>{
    const users = snap.val() || {};
    for(const uid in users){
      if(uid===currentUser.uid) continue;

      const u=users[uid];
      const name=(u.displayName||"").toLowerCase();
      if(name.includes(kw)||uid.includes(kw)){
        searchResultsDiv.appendChild(
          createUserDiv(
            {id:uid, displayName:u.displayName, photoURL:u.photoURL||"https://via.placeholder.com/40"},
            "search"
          )
        );
      }
    }
  });
});
</script>
</body>
</html>
