<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }

    .top-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: #eee;
    }

    #searchInput {
      flex: 1;
      padding: 8px;
    }

    .notify-button {
      padding: 8px 12px;
      background: #ccc;
      border-radius: 6px;
      cursor: pointer;
    }

    .container {
      display: flex;
      height: calc(100vh - 60px);
    }

    .left-pane {
      width: 300px;
      border-right: 1px solid #ddd;
      padding: 10px;
      overflow-y: auto;
    }

    .section-title {
      font-weight: bold;
      margin-top: 10px;
    }

    .user-item {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .follow-btn {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid #aaa;
      background: #f7f7f7;
    }

    /* é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ */
    .notification-center {
      position: fixed;
      right: 10px;
      top: 60px;
      width: 250px;
      max-height: 300px;
      background: white;
      border: 1px solid #aaa;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
      overflow-y: auto;
      display: none;
      padding: 10px;
    }

    .notification-item {
      border-bottom: 1px solid #ccc;
      padding: 6px;
    }

    .back-btn {
      margin-left: 10px;
      padding: 3px 6px;
      background: #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<div class="top-bar">
  <input id="searchInput" type="text" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢" />
  <div id="notifyBtn" class="notify-button">ğŸ””é€šçŸ¥</div>
</div>

<!-- é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ -->
<div id="notificationCenter" class="notification-center"></div>

<div class="container">

  <div class="left-pane">

    <div class="section-title">ğŸ”æ¤œç´¢å€™è£œ</div>
    <div id="searchResults"></div>

    <div class="section-title">ğŸ‘¤ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</div>
    <div id="followList"></div>

    <div class="section-title">ğŸ’¬ãƒˆãƒ¼ã‚¯ä¸€è¦§</div>
    <div id="dmList"></div>

  </div>

  <div style="flex:1; display:flex; justify-content:center; align-items:center; color:#888;">
    DMç›¸æ‰‹ã‚’é¸ã‚“ã§ã¡ã‚‡ã€œğŸ“¨
  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  /* ===============================
     Firebase åˆæœŸåŒ–ï¼ˆè‡ªåˆ†ã®ã‚’å…¥ã‚Œã¦ã­ï¼‰
  =============================== */
  const firebaseConfig = {
    apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;
  let allUsers = {};
  let notificationList = []; // æœ€å¤§10ä»¶ã¾ã§ä¿æŒ


  /* ============================
        ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
  ============================ */
  auth.onAuthStateChanged(user => {
    if (!user) location.href = "login.html";
    currentUser = user;
    loadAllUsers();
    loadFollowList();
    loadDMList();
    loadNotifications();
  });

  /* ============================
        å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
  ============================ */
  function loadAllUsers() {
    db.ref("users").on("value", snap => {
      allUsers = snap.val() || {};
    });
  }

  /* ============================
        é€šçŸ¥èª­ã¿è¾¼ã¿ï¼ˆæœ€å¤§10ä»¶ï¼‰
  ============================ */
  function loadNotifications() {
    db.ref("notifications/" + currentUser.uid)
      .limitToLast(10)
      .on("value", snap => {
        notificationList = [];
        snap.forEach(child => notificationList.push(child.val()));
        renderNotifications();
      });
  }

  function renderNotifications() {
    const nc = document.getElementById("notificationCenter");
    nc.innerHTML = "";

    notificationList
      .slice()
      .reverse()
      .forEach(n => {
        const d = document.createElement("div");
        d.className = "notification-item";
        d.innerHTML = `
          <div>${n.text}</div>
          <button class="back-btn" onclick="followBack('${n.from}')">ãƒ•ã‚©ãƒ­ãƒ</button>
        `;
        nc.appendChild(d);
      });
  }

  document.getElementById("notifyBtn").onclick = () => {
    const nc = document.getElementById("notificationCenter");
    nc.style.display = (nc.style.display === "none") ? "block" : "none";
  };

  function followBack(uid) {
    toggleFollow(uid);
  }


  /* ============================
        æ¤œç´¢å‡¦ç†
  ============================ */
  document.getElementById("searchInput").oninput = e => {
    const word = e.target.value;
    renderSearch(word);
  };

  function renderSearch(word) {
    const area = document.getElementById("searchResults");
    area.innerHTML = "";

    if (!word) return;

    Object.entries(allUsers).forEach(([id, u]) => {
      if (id === currentUser.uid) return;
      if (!u.name.includes(word)) return;

      area.appendChild(makeUserRow(id, u, "search"));
    });
  }

  /* ============================
        ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ãƒªã‚¹ãƒˆè¡¨ç¤º
  ============================ */
  function loadFollowList() {
    db.ref("users/" + currentUser.uid + "/following").on("value", snap => {
      const list = snap.val() || [];
      const area = document.getElementById("followList");
      area.innerHTML = "";

      list.forEach(uid => {
        if (allUsers[uid]) {
          area.appendChild(makeUserRow(uid, allUsers[uid], "follow"));
        }
      });
    });
  }


  /* ============================
        DM ãƒªã‚¹ãƒˆ
  ============================ */
  function loadDMList() {
    db.ref("users/" + currentUser.uid + "/following").on("value", snap => {
      const myFollows = snap.val() || [];
      const area = document.getElementById("dmList");
      area.innerHTML = "";

      myFollows.forEach(uid => {
        if (!allUsers[uid]) return;

        db.ref("users/" + uid + "/following")
          .once("value")
          .then(s2 => {
            const theyFollow = s2.val() || [];

            if (theyFollow.includes(currentUser.uid)) {
              // ç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼ãªã®ã§DMå¯
              const row = makeUserRow(uid, allUsers[uid], "dm");
              row.onclick = () => {
                location.href = "dm.html?opponentId=" + uid;
              };
              area.appendChild(row);
            }
          });
      });
    });
  }


  /* ============================
        ãƒ•ã‚©ãƒ­ãƒ¼ãƒœã‚¿ãƒ³ç”Ÿæˆ
  ============================ */
  function makeUserRow(uid, user, mode) {
    const div = document.createElement("div");
    div.className = "user-item";

    const name = document.createElement("span");
    name.textContent = user.name;

    const btn = document.createElement("button");
    btn.className = "follow-btn";

    // è‡ªåˆ†ã®ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ³ç¢ºèª
    db.ref("users/" + currentUser.uid + "/following")
      .once("value")
      .then(snap => {
        const list = snap.val() || [];
        btn.textContent = list.includes(uid) ? "ãƒ•ã‚©ãƒ­ãƒ¼ä¸­" : "ãƒ•ã‚©ãƒ­ãƒ¼";
      });

    btn.onclick = (e) => {
      e.stopPropagation();
      toggleFollow(uid);
    };

    // DMãƒ¢ãƒ¼ãƒ‰ã¯ãƒ•ã‚©ãƒ­ãƒ¼è¡¨ç¤ºã—ãªã„
    if (mode === "dm") {
      div.appendChild(name);
      return div;
    }

    div.appendChild(name);
    div.appendChild(btn);
    return div;
  }


  /* ============================
        ãƒ•ã‚©ãƒ­ãƒ¼å‡¦ç†ï¼ˆç›¸äº’å¯¾å¿œï¼‰
  ============================ */
  function toggleFollow(targetUid) {
    const ref = db.ref("users/" + currentUser.uid + "/following");

    ref.once("value").then(snap => {
      const list = snap.val() || [];

      if (list.includes(targetUid)) {
        // è§£é™¤
        const newList = list.filter(x => x !== targetUid);
        ref.set(newList);
      } else {
        // è¿½åŠ 
        list.push(targetUid);
        ref.set(list);

        // ç›¸æ‰‹ã«é€šçŸ¥ã‚’10ä»¶ã¾ã§ä¿å­˜
        const nRef = db.ref("notifications/" + targetUid);
        const n = {
          text: allUsers[currentUser.uid].name + " ã•ã‚“ã‹ã‚‰ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚ŒãŸã§ï¼ğŸ”¥",
          from: currentUser.uid,
          time: Date.now()
        };

        nRef.push(n);
        nRef.once("value").then(snap => {
          const count = snap.numChildren();
          if (count > 10) {
            const firstKey = Object.keys(snap.val())[0];
            nRef.child(firstKey).remove();
          }
        });
      }
    });
  }


</script>

</body>
  </html>
