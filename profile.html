<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>プロフィール設定</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background: #f0f0f0;
        }

        .container {
            max-width: 430px;
            margin: 30px auto;
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 10px #ccc;
        }

        h2 {
            text-align: center;
            margin-bottom: 5px;
        }

        /* 現在のプロフィール表示ゾーン */
        .current-profile {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .current-profile img {
            width: 90px;
            height: 90px;
            border-radius: 90px;
            object-fit: cover;
            border: 2px solid #aaa;
        }
        .current-name {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
        }

        label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 4px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .btn {
            width: 100%;
            margin-top: 20px;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: #4e8cff;
            color: #fff;
            font-size: 15px;
            cursor: pointer;
        }

        .btn:hover {
            opacity: 0.85;
        }

        .icon-preview {
            text-align: center;
            margin-top: 15px;
        }

        .icon-preview img {
            width: 100px;
            height: 100px;
            border-radius: 100px;
            object-fit: cover;
            border: 2px solid #aaa;
        }

        .back-btn {
            margin-top: 15px;
            text-align: center;
        }
        .back-btn a {
            color: #4e8cff;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>プロフィール設定</h2>

        <!-- 現在のプロフィール表示 -->
        <div class="current-profile">
            <img id="currentIcon" src="" alt="icon">
            <div class="current-name" id="currentName">読み込み中…</div>
        </div>

        <!-- 新しい設定 -->
        <label>表示名</label>
        <input id="displayNameInput" type="text" />

        <label>アイコンURL</label>
        <input id="photoURLInput" type="text" />

        <label>自己紹介</label>
        <textarea id="bioInput" rows="3"></textarea>

        <div class="icon-preview">
            <img id="iconPreview" src="" alt="icon">
        </div>

        <button class="btn" id="saveBtn">保存する</button>

        <div class="back-btn">
            <a href="chat.html">← チャットに戻る</a>
        </div>
    </div>


    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const currentName = document.getElementById("currentName");
        const currentIcon = document.getElementById("currentIcon");

        const displayNameInput = document.getElementById("displayNameInput");
        const photoURLInput = document.getElementById("photoURLInput");
        const bioInput = document.getElementById("bioInput");
        const iconPreview = document.getElementById("iconPreview");
        const saveBtn = document.getElementById("saveBtn");

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert("ログインしてちょ〜");
                location.href = "login.html";
                return;
            }

            const ref = doc(db, "users", user.uid);
            const snap = await getDoc(ref);

            if (snap.exists()) {
                const data = snap.data();

                // 現在のプロフィール表示
                currentName.textContent = data.displayName ?? "名前なし";
                currentIcon.src = data.photoURL ?? "";

                // 編集欄に反映
                displayNameInput.value = data.displayName ?? "";
                photoURLInput.value = data.photoURL ?? "";
                bioInput.value = data.bio ?? "";
                iconPreview.src = data.photoURL ?? "";
            }
        });

        photoURLInput.addEventListener("input", () => {
            iconPreview.src = photoURLInput.value;
        });

        saveBtn.addEventListener("click", async () => {
            const user = auth.currentUser;
            if (!user) return;

            const newName = displayNameInput.value.trim();
            const newIcon = photoURLInput.value.trim();
            const newBio = bioInput.value.trim();

            // Auth 側更新
            await updateProfile(user, {
                displayName: newName,
                photoURL: newIcon
            });

            // Firestore 更新
            const ref = doc(db, "users", user.uid);
            await updateDoc(ref, {
                displayName: newName,
                photoURL: newIcon,
                bio: newBio
            });

            alert("変更保存したでよ〜‼️✨");

            // ⭐ 保存後 chat.html に戻る
            location.href = "chat.html";
        });
    </script>

</body>
</html>
