<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ユーザー設定</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            background: #f0f0f0;
        }

        .container {
            max-width: 420px;
            margin: 30px auto;
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 10px #ccc;
        }

        h2 {
            text-align: center;
        }

        label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 4px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .btn {
            width: 100%;
            margin-top: 20px;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: #4e8cff;
            color: #fff;
            font-size: 15px;
            cursor: pointer;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .icon-preview {
            text-align: center;
            margin-top: 15px;
        }

        .icon-preview img {
            width: 100px;
            height: 100px;
            border-radius: 100px;
            object-fit: cover;
            border: 2px solid #aaa;
        }

        .back-btn {
            margin-top: 15px;
            text-align: center;
        }
        .back-btn a {
            text-decoration: none;
            color: #4e8cff;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>プロフィール設定</h2>

        <div class="icon-preview">
            <img id="iconPreview" src="" alt="icon">
        </div>

        <label>表示名</label>
        <input id="displayNameInput" type="text" />

        <label>アイコンURL</label>
        <input id="photoURLInput" type="text" />

        <label>自己紹介</label>
        <textarea id="bioInput" rows="3"></textarea>

        <button class="btn" id="saveBtn">保存する</button>

        <div class="back-btn">
            <a href="chat.html">← チャットに戻る</a>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "（あなたのAPIキー）",
            authDomain: "（あなたのAuth）",
            projectId: "（あなたのID）",
            storageBucket: "（あなたのストレージ）",
            messagingSenderId: "（あなたのID）",
            appId: "（あなたのAppID）"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const displayNameInput = document.getElementById("displayNameInput");
        const photoURLInput = document.getElementById("photoURLInput");
        const bioInput = document.getElementById("bioInput");
        const iconPreview = document.getElementById("iconPreview");
        const saveBtn = document.getElementById("saveBtn");

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert("ログインしてください");
                location.href = "login.html";
                return;
            }

            const ref = doc(db, "users", user.uid);
            const snap = await getDoc(ref);

            if (snap.exists()) {
                const data = snap.data();
                displayNameInput.value = data.displayName ?? "";
                photoURLInput.value = data.photoURL ?? "";
                bioInput.value = data.bio ?? "";
                if (data.photoURL) iconPreview.src = data.photoURL;
            }
        });

        photoURLInput.addEventListener("input", () => {
            iconPreview.src = photoURLInput.value;
        });

        saveBtn.addEventListener("click", async () => {
            const user = auth.currentUser;
            if (!user) return;

            const newName = displayNameInput.value.trim();
            const newIcon = photoURLInput.value.trim();
            const newBio = bioInput.value.trim();

            // Auth の profile 更新
            await updateProfile(user, {
                displayName: newName,
                photoURL: newIcon
            });

            // Firestore 側の users/{uid} 更新
            const ref = doc(db, "users", user.uid);
            await updateDoc(ref, {
                displayName: newName,
                photoURL: newIcon,
                bio: newBio,
            });

            alert("保存したでよ〜‼️✨");
            location.href = "chat.html";
        });
    </script>
</body>
</html>
