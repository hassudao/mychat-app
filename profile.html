<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>プロフィール設定</title>

<style>
body {
    font-family: sans-serif;
    background: #f0f0f0;
}
.container {
    max-width: 430px;
    margin: 30px auto;
    background: #fff;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 0 10px #ccc;
}
h2 {
    text-align: center;
    margin-bottom: 5px;
}
.current-profile {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #ddd;
}
.current-profile img {
    width: 90px;
    height: 90px;
    border-radius: 90px;
    object-fit: cover;
    border: 2px solid #aaa;
}
.current-name {
    margin-top: 10px;
    font-size: 18px;
    font-weight: bold;
}
label {
    font-weight: bold;
    margin-top: 10px;
    display: block;
}
input, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 4px;
    border-radius: 8px;
    border: 1px solid #ccc;
}
.btn {
    width: 100%;
    margin-top: 20px;
    padding: 12px;
    border: none;
    border-radius: 10px;
    background: #4e8cff;
    color: #fff;
    font-size: 15px;
    cursor: pointer;
}
.btn:hover { opacity: 0.9; }
.icon-preview {
    text-align: center;
    margin-top: 15px;
}
.icon-preview img {
    width: 100px;
    height:100px;
    border-radius: 100px;
    border: 2px solid #aaa;
    object-fit: cover;
}
</style>

<!-- Firebase Compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>
<body>

<div class="container">
    <h2>プロフィール設定</h2>

    <!-- 現在のプロフィール表示 -->
    <div class="current-profile">
        <img id="currentIcon" src="">
        <div class="current-name" id="currentName">読み込み中…</div>
    </div>

    <label>表示名</label>
    <input id="displayNameInput" type="text">

    <label>アイコンURL</label>
    <input id="photoURLInput" type="text">

    <label>自己紹介</label>
    <textarea id="bioInput" rows="3"></textarea>

    <div class="icon-preview">
        <img id="iconPreview" src="">
    </div>

    <button class="btn" id="saveBtn">保存する</button>
</div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

/* DOM */
const currentName = document.getElementById("currentName");
const currentIcon = document.getElementById("currentIcon");
const displayNameInput = document.getElementById("displayNameInput");
const photoURLInput = document.getElementById("photoURLInput");
const bioInput = document.getElementById("bioInput");
const iconPreview = document.getElementById("iconPreview");
const saveBtn = document.getElementById("saveBtn");

auth.onAuthStateChanged(async user=>{
    if(!user){
        alert("ログインしてちょ〜");
        location.href="index.html";
        return;
    }

    const ref = db.ref("users/" + user.uid);
    ref.once("value").then(snap=>{
        const data = snap.val() || {};

        /* 現在プロフィール */
        currentName.textContent = data.displayName || "名前未設定";
        currentIcon.src = data.photoURL || "https://via.placeholder.com/100";

        /* 入力欄にも反映 */
        displayNameInput.value = data.displayName || "";
        photoURLInput.value = data.photoURL || "";
        bioInput.value = data.bio || "";
        iconPreview.src = data.photoURL || "";
    });
});

/* アイコンプレビュー */
photoURLInput.addEventListener("input", ()=>{
    iconPreview.src = photoURLInput.value;
});

/* 保存 */
saveBtn.onclick = async ()=>{
    const user = auth.currentUser;
    if(!user) return;

    const newData = {
        displayName: displayNameInput.value.trim(),
        photoURL: photoURLInput.value.trim(),
        bio: bioInput.value.trim()
    };

    /* Auth 側にも反映（名前 + 画像） */
    await user.updateProfile({
        displayName: newData.displayName,
        photoURL: newData.photoURL
    });

    /* Realtime DB に保存 */
    db.ref("users/" + user.uid).update(newData);

    alert("保存したがね〜‼️");

    /* 保存後チャットに戻る */
    location.href = "chat.html";
};
</script>

</body>
    </html>
