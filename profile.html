<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ユーザープロフィール</title>
<style>
body { font-family:sans-serif; padding:20px; }
body.dark { background:#1e1e1e; color:#f0f0f0; }
#avatar { width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:32px; background:#666; color:#fff; margin-bottom:10px; }
#followBtn { padding:5px 10px; margin-top:10px; }
.counts { margin-top:10px; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<h2 id="userName">ユーザー名</h2>
<div id="avatar"></div>
<div class="counts">
  フォロー中: <span id="followingCount">0</span><br>
  フォロワー: <span id="followersCount">0</span>
</div>
<button id="followBtn">フォロー</button>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

let currentUser=null;
let targetUid=null;

auth.onAuthStateChanged(user=>{
  if(!user) location.href="index.html";
  currentUser=user;
  const urlParams = new URLSearchParams(window.location.search);
  targetUid = urlParams.get("uid");
  if(!targetUid){ alert("ユーザーが見つかりません"); location.href="chat.html"; return; }
  loadProfile(targetUid);
});

function loadProfile(uid){
  database.ref("users/"+uid).get().then(snap=>{
    if(!snap.exists()) return alert("ユーザー情報が見つかりません");
    const user = snap.val();
    document.getElementById("userName").textContent = user.displayName || "名無し";
    const avatarDiv=document.getElementById("avatar");
    avatarDiv.innerHTML="";
    if(user.photoURL){
      const img=document.createElement("img");
      img.src=user.photoURL;
      img.style.width="80px";
      img.style.height="80px";
      img.style.borderRadius="50%";
      avatarDiv.appendChild(img);
    } else {
      avatarDiv.textContent=user.displayName[0].toUpperCase();
    }
    updateFollowCounts(uid);
    updateFollowButton(uid);
  });
}

// フォロー数・フォロワー数
function updateFollowCounts(uid){
  // フォロー数
  database.ref("follows/"+uid).get().then(snap=>{
    document.getElementById("followingCount").textContent = snap.exists()? Object.keys(snap.val()).length : 0;
  });
  // フォロワー数
  database.ref("follows").get().then(snap=>{
    const data = snap.val(); let count=0;
    if(data) Object.values(data).forEach(f=>{ if(f[uid]) count++; });
    document.getElementById("followersCount").textContent = count;
  });
}

// フォロー/解除ボタン
function updateFollowButton(uid){
  const btn=document.getElementById("followBtn");
  if(uid===currentUser.uid){ btn.style.display="none"; return; } // 自分は非表示
  database.ref(`follows/${currentUser.uid}/${uid}`).on("value", snap=>{
    if(snap.exists()){
      btn.textContent="フォロー中";
      btn.onclick = ()=>{ database.ref(`follows/${currentUser.uid}/${uid}`).remove(); };
    } else {
      btn.textContent="フォロー";
      btn.onclick = ()=>{
        database.ref(`follows/${currentUser.uid}/${uid}`).set(true);
        database.ref(`notifications/${uid}`).push({
          type:"follow",
          fromUid: currentUser.uid,
          fromName: currentUser.displayName || "名無し",
          timestamp: Date.now(),
          read:false
        });
      };
    }
  });
}
</script>
</body>
  </html>
