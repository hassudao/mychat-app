<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyChat - DM</title>
<style>
  body { font-family:sans-serif; margin:0; display:flex; flex-direction:column; height:100vh; transition: background 0.3s, color 0.3s; }
  body.dark { background:#121212; color:#f0f0f0; }
  header { background:#6200ea; color:white; padding:10px; display:flex; align-items:center; justify-content:space-between; }
  header .left { display:flex; align-items:center; gap:10px; }
  header img { width:40px; height:40px; border-radius:50%; }
  #messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:10px; }
  .msgContainer { display:flex; align-items:flex-end; gap:8px; }
  .msg { max-width:70%; padding:8px 12px; border-radius:15px; word-wrap:break-word; }
  .myMsg { background:#6200ea; color:white; align-self:flex-end; border-radius:15px 15px 3px 15px; }
  .otherMsg { background:#e0e0e0; color:black; align-self:flex-start; border-radius:15px 15px 15px 3px; }
  .msgIcon { width:35px; height:35px; border-radius:50%; vertical-align:middle; }
  .msgTime { font-size:0.7em; color:#555; margin-left:5px; }
  .msgRead { font-size:0.7em; color:#555; margin-left:5px; }
  footer { padding:10px; display:flex; gap:5px; border-top:1px solid #ccc; background:white; }
  #msgInput { flex:1; padding:8px; border-radius:20px; border:1px solid #ccc; }
  button { padding:8px 12px; border:none; border-radius:20px; background:#6200ea; color:white; cursor:pointer; }

  /* Ê§úÁ¥¢„Éê„Éº */
  #searchBar { width:100%; padding:8px; border:1px solid #ccc; border-radius:20px; margin-bottom:10px; }
  #searchResults { max-height:200px; overflow-y:auto; margin-bottom:10px; }
  .searchItem { display:flex; align-items:center; gap:10px; padding:5px; border-bottom:1px solid #ddd; cursor:pointer; }
  .searchItem img { width:35px; height:35px; border-radius:50%; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
<header>
  <div class="left">
    <button id="backBtn">‚óÄ‰∏ÄË¶ß</button>
    <img id="opponentIcon" src="https://via.placeholder.com/40">
    <span id="opponentName">„É¶„Éº„Ç∂„Éº</span>
  </div>
  <button id="settingsBtn">‚öôÔ∏è Ë®≠ÂÆö</button>
</header>

<!-- „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢„Éê„Éº -->
<input type="text" id="searchBar" placeholder="„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢...">
<div id="searchResults"></div>

<div id="messages"></div>

<footer>
  <input type="text" id="msgInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...">
  <button id="sendBtn">ÈÄÅ‰ø°</button>
</footer>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

const params = new URLSearchParams(window.location.search);
const opponentId = params.get("opponentId");

const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const opponentIconImg = document.getElementById("opponentIcon");
const opponentNameSpan = document.getElementById("opponentName");
const backBtn = document.getElementById("backBtn");
const settingsBtn = document.getElementById("settingsBtn");

const searchBar = document.getElementById("searchBar");
const searchResults = document.getElementById("searchResults");

let currentUser = null;
let opponentData = null;

// DMË®≠ÂÆöÈÅ©Áî®
function applyDMSettings(){
  const bg = localStorage.getItem("dmBg") || "#f4f4f8";
  document.body.style.background = bg;
  if(localStorage.getItem("dmDarkMode")==="true") document.body.classList.add("dark");
  else document.body.classList.remove("dark");
}

applyDMSettings();

auth.onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  currentUser = user;

  // Áõ∏ÊâãÊÉÖÂ†±ÂèñÂæó
  database.ref("users/"+opponentId).once("value").then(snap=>{
    opponentData = snap.val();
    if(!opponentData) alert("Áõ∏Êâã„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì");
    opponentIconImg.src = opponentData.photoURL || "https://via.placeholder.com/40";
    opponentNameSpan.textContent = opponentData.displayName || "„É¶„Éº„Ç∂„Éº";
    startListening();
  });
});

// Êàª„Çã„Éú„Çø„É≥
backBtn.onclick = ()=> location.href="chat.html";

// Ë®≠ÂÆö„Éú„Çø„É≥
settingsBtn.onclick = ()=> location.href="dm-settings.html?opponentId="+opponentId;

// „ÉÅ„É£„ÉÉ„ÉàID
function getChatId(){ return currentUser.uid < opponentId ? currentUser.uid+"_"+opponentId : opponentId+"_"+currentUser.uid; }

// „É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°
function startListening(){
  const chatRef = database.ref(`messages/${getChatId()}`);
  chatRef.on("value", snap=>{
    const msgs = snap.val() || {};
    messagesDiv.innerHTML = "";
    Object.entries(msgs).sort((a,b)=>a[1].timestamp-b[1].timestamp).forEach(([key,m])=>{
      const div = document.createElement("div");
      div.className = "msgContainer";

      const msgDiv = document.createElement("div");
      msgDiv.className = m.sender===currentUser.uid ? "msg myMsg" : "msg otherMsg";
      msgDiv.textContent = m.content;

      const iconImg = document.createElement("img");
      iconImg.className="msgIcon";
      iconImg.src = m.sender===currentUser.uid ? currentUser.photoURL : opponentData.photoURL;

      const timeSpan = document.createElement("span");
      timeSpan.className="msgTime";
      timeSpan.textContent = new Date(m.timestamp).toLocaleTimeString();

      const readSpan = document.createElement("span");
      readSpan.className="msgRead";
      readSpan.textContent = (m.sender===currentUser.uid && m.read) ? "Êó¢Ë™≠" : "";

      if(m.sender===currentUser.uid){
        div.appendChild(msgDiv);
        div.appendChild(iconImg);
        div.appendChild(timeSpan);
        div.appendChild(readSpan);
      } else {
        div.appendChild(iconImg);
        div.appendChild(msgDiv);
        div.appendChild(timeSpan);
      }

      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
sendBtn.onclick = ()=>{
  const content = msgInput.value;
  if(!content) return;
  const chatId = getChatId();
  database.ref(`messages/${chatId}`).push({
    sender: currentUser.uid,
    content: content,
    timestamp: Date.now(),
    read: false
  });
  database.ref(`chats/${currentUser.uid}/list/${opponentId}`).set({lastMessage: content});
  database.ref(`chats/${opponentId}/list/${currentUser.uid}`).set({lastMessage: content});
  msgInput.value="";
};

// üîπ „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢ÔºàËá™ÂàÜÈô§Â§ñÔºâ
searchBar.addEventListener("input", ()=>{
  const query = searchBar.value.trim().toLowerCase();
  searchResults.innerHTML = "";
  if(!query) return;

  database.ref("users").orderByChild("displayName").startAt(query).endAt(query+"\uf8ff")
  .once("value").then(snapshot=>{
    const users = snapshot.val() || {};
    Object.entries(users)
      .filter(([uid,user])=>uid!==currentUser.uid) // Ëá™ÂàÜÈô§Â§ñ
      .forEach(([uid,user])=>{
        const item = document.createElement("div");
        item.className="searchItem";
        item.innerHTML = `<img src="${user.photoURL || 'https://via.placeholder.com/40'}"><span>${user.displayName}</span>`;
        item.onclick = ()=> location.href="dm.html?opponentId="+uid;
        searchResults.appendChild(item);
      });
  });
});
</script>
</body>
</html>
