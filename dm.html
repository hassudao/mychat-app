<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MyChat - DM</title>
  <style>
    body { font-family:sans-serif; padding:20px; }
    #messages { height:400px; overflow-y:scroll; border:1px solid #ccc; margin:10px auto; max-width:400px; padding:10px; }
    #msgInput { width:300px; padding:5px; }
    button { padding:5px 10px; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, getDoc, doc, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
      authDomain: "chatapp-hassu.firebaseapp.com",
      databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chatapp-hassu",
      storageBucket: "chatapp-hassu.appspot.com",
      messagingSenderId: "8489684752",
      appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const urlParams = new URLSearchParams(window.location.search);
    const opponentId = urlParams.get("opponentId");

    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    onAuthStateChanged(auth, async (user) => {
      if(!user){ location.href="index.html"; return; }

      // 相手存在チェック
      const userRef = doc(db,"users",opponentId);
      const userSnap = await getDoc(userRef);
      if(!userSnap.exists() || userSnap.data().active === false){
        location.href="chat.html";
        return;
      }

      sendBtn.onclick = async ()=>{
        const content = msgInput.value;
        if(!content) return;
        const chatRef = collection(db,"chats",user.uid,"list");
        await addDoc(chatRef,{ lastMessage: content, timestamp: Date.now() });
        msgInput.value = "";
        loadMessages(user.uid);
      };

      loadMessages(user.uid);
    });

    async function loadMessages(currentUserId){
      const chatRef = collection(db,"chats",currentUserId,"list");
      const chatSnap = await getDocs(chatRef);
      messagesDiv.innerHTML = "";
      for(const docSnap of chatSnap.docs){
        if(docSnap.id!==opponentId) continue;
        const data = docSnap.data();
        messagesDiv.innerHTML += `<p>${opponentId}: ${data.lastMessage}</p>`;
      }
    }
  </script>
</head>
<body>
  <h2>DM</h2>
  <div id="messages"></div>
  <input type="text" id="msgInput" placeholder="メッセージ入力…">
  <button id="sendBtn">送信！</button>
</body>
</html>
