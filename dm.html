<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyChat - DM</title>
<style>
  body { font-family:sans-serif; margin:0; display:flex; flex-direction:column; height:100vh; transition: background 0.3s, color 0.3s; }
  body.dark { background:#121212; color:#f0f0f0; }

  header {
    position:fixed; top:0; width:100%; background:#6200ea; color:white; padding:10px; display:flex; align-items:center; justify-content:space-between; z-index:1000;
  }
  header .left { display:flex; align-items:center; gap:10px; }
  header img { width:40px; height:40px; border-radius:50%; }

  #messages { flex:1; overflow-y:auto; padding:70px 10px 70px 10px; display:flex; flex-direction:column; gap:10px; }
  .date-separator { text-align:center; font-size:0.8em; opacity:0.6; margin:10px 0; }

  .msgContainer { display:flex; align-items:flex-end; gap:8px; }
  .msg { max-width:70%; padding:8px 12px; border-radius:15px; word-wrap:break-word; position:relative; }
  .myMsg { background:#6200ea; color:white; margin-left:auto; border-bottom-right-radius:3px; }
  .otherMsg { background:#e0e0e0; color:black; margin-right:auto; border-bottom-left-radius:3px; }

  .msgIcon { width:35px; height:35px; border-radius:50%; vertical-align:middle; }
  .msgTimeInside { display:block; text-align:right; font-size:0.65em; opacity:0.5; margin-top:2px; }
  .delBtn { cursor:pointer; font-size:1.1em; margin-right:5px; user-select:none; }

  footer { position:fixed; bottom:0; width:100%; padding:10px; display:flex; gap:5px; border-top:1px solid #ccc; background:white; transition: background 0.3s, color 0.3s; }
  body.dark footer { background:#1e1e1e; }
  #msgInput { flex:1; padding:8px; border-radius:20px; border:1px solid #ccc; transition: background 0.3s, color 0.3s, border-color 0.3s; }
  body.dark #msgInput { background:#2c2c2c; color:white; border-color:#555; }

  button { padding:8px 12px; border:none; border-radius:20px; background:#6200ea; color:white; cursor:pointer; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
<header>
  <div class="left">
    <button id="backBtn">‚óÄ‰∏ÄË¶ß</button>
    <img id="opponentIcon" src="https://via.placeholder.com/40">
    <span id="opponentName">„É¶„Éº„Ç∂„Éº</span>
  </div>
  <button id="settingsBtn">‚öôÔ∏è Ë®≠ÂÆö</button>
</header>

<div id="messages"></div>

<footer>
  <input type="text" id="msgInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...">
  <button id="sendBtn">ÈÄÅ‰ø°</button>
</footer>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

const params = new URLSearchParams(window.location.search);
const opponentId = params.get("opponentId");

const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const opponentIconImg = document.getElementById("opponentIcon");
const opponentNameSpan = document.getElementById("opponentName");
const backBtn = document.getElementById("backBtn");
const settingsBtn = document.getElementById("settingsBtn");

let currentUser = null;
let opponentData = null;

// „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÈÅ©Áî®
function applyDMSettings(){
  if(localStorage.getItem("dmDarkMode")==="true") document.body.classList.add("dark");
  else document.body.classList.remove("dark");
}
applyDMSettings();

auth.onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  currentUser = user;
  database.ref("users/"+opponentId).once("value").then(snap=>{
    opponentData = snap.val();
    if(!opponentData) alert("Áõ∏Êâã„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì");
    opponentIconImg.src = opponentData.photoURL || "https://via.placeholder.com/40";
    opponentNameSpan.textContent = opponentData.displayName || "„É¶„Éº„Ç∂„Éº";
    startListening();
  });
});

backBtn.onclick = ()=> location.href="chat.html";
settingsBtn.onclick = ()=> location.href="dm-settings.html?opponentId="+opponentId;

function getChatId(){ return currentUser.uid < opponentId ? currentUser.uid+"_"+opponentId : opponentId+"_"+currentUser.uid; }

function formatDate(ts){
  const d = new Date(ts);
  return d.getFullYear()+"-"+(d.getMonth()+1).toString().padStart(2,"0")+"-"+d.getDate().toString().padStart(2,"0");
}

function startListening(){
  const chatRef = database.ref(`messages/${getChatId()}`);
  let lastDate = "";
  chatRef.on("value", snap=>{
    const msgs = snap.val() || {};
    messagesDiv.innerHTML = "";
    Object.entries(msgs)
      .sort((a,b)=>a[1].timestamp - b[1].timestamp)
      .forEach(([key, m])=>{
        const msgDate = formatDate(m.timestamp);
        if(msgDate !== lastDate){
          const sep = document.createElement("div");
          sep.className = "date-separator";
          sep.textContent = msgDate;
          messagesDiv.appendChild(sep);
          lastDate = msgDate;
        }

        const div = document.createElement("div");
        div.className = "msgContainer";

        // ÂâäÈô§„Éú„Çø„É≥ÔºàËá™ÂàÜ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„ÅøÔºâ
        if(m.sender === currentUser.uid){
          const delBtn = document.createElement("span");
          delBtn.className = "delBtn";
          delBtn.textContent = "üóë";
          delBtn.onclick = ()=>{
            if(confirm("„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")){
              database.ref(`messages/${getChatId()}/${key}`).remove();
            }
          };
          div.appendChild(delBtn);
        }

        const msgDiv = document.createElement("div");
        msgDiv.className = m.sender===currentUser.uid ? "msg myMsg" : "msg otherMsg";

        const textSpan = document.createElement("span");
        textSpan.textContent = m.content;
        msgDiv.appendChild(textSpan);

        const timeSpan = document.createElement("span");
        timeSpan.className = "msgTimeInside";
        timeSpan.textContent = new Date(m.timestamp)
          .toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

        // Êó¢Ë™≠Ë°®Á§∫
        if(m.sender === currentUser.uid && m.read === true){
          const readSpan = document.createElement("span");
          readSpan.style.fontSize = "0.65em";
          readSpan.style.opacity = "0.5";
          readSpan.textContent = "ÔºàÊó¢Ë™≠Ôºâ";
          timeSpan.appendChild(readSpan);
        }

        msgDiv.appendChild(timeSpan);

        const iconImg = document.createElement("img");
        iconImg.className="msgIcon";
        iconImg.src = m.sender===currentUser.uid ? 
          (currentUser.photoURL || "https://via.placeholder.com/35") :
          (opponentData.photoURL || "https://via.placeholder.com/35");

        if(m.sender===currentUser.uid){
          div.appendChild(msgDiv);
          div.appendChild(iconImg);
        } else {
          div.appendChild(iconImg);
          div.appendChild(msgDiv);
        }

        messagesDiv.appendChild(div);
      });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    markAsRead();
  });
}

// Ëá™ÂàÜ‰ª•Â§ñ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊó¢Ë™≠„Å´
function markAsRead(){
  const chatId = getChatId();
  database.ref(`messages/${chatId}`).once("value", snap=>{
    snap.forEach(s=>{
      if(s.val().sender !== currentUser.uid && !s.val().read){
        database.ref(`messages/${chatId}/${s.key}/read`).set(true);
      }
    });
  });
}

sendBtn.onclick = ()=>{
  const content = msgInput.value;
  if(!content) return;
  const chatId = getChatId();
  database.ref(`messages/${chatId}`).push({
    sender: currentUser.uid,
    content: content,
    timestamp: Date.now(),
    read: false
  });
  database.ref(`chats/${currentUser.uid}/list/${opponentId}`).set({lastMessage: content});
  database.ref(`chats/${opponentId}/list/${currentUser.uid}`).set({lastMessage: content});
  msgInput.value="";
};
</script>
</body>
</html>
