<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MyChat - DM</title>
<style>
  body { font-family:sans-serif; margin:0; background:#f4f4f8; display:flex; flex-direction:column; height:100vh; }
  header { background:#6200ea; color:white; padding:10px; display:flex; align-items:center; }
  header img { width:40px; height:40px; border-radius:50%; margin-right:10px; }
  header span { font-weight:bold; font-size:1.2em; }
  #messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:10px; }
  .msg { display:flex; max-width:70%; padding:8px 12px; border-radius:15px; word-wrap:break-word; }
  .myMsg { background:#6200ea; color:white; align-self:flex-end; border-bottom-right-radius:3px; }
  .otherMsg { background:#e0e0e0; color:black; align-self:flex-start; border-bottom-left-radius:3px; }
  .msgIcon { width:35px; height:35px; border-radius:50%; margin-right:8px; }
  .msgContainer { display:flex; align-items:flex-end; gap:8px; }
  .msgTime { font-size:0.7em; color:#555; margin-left:5px; }
  .msgRead { font-size:0.7em; color:#555; margin-left:5px; }
  footer { padding:10px; display:flex; gap:5px; border-top:1px solid #ccc; background:white; }
  #msgInput { flex:1; padding:8px; border-radius:20px; border:1px solid #ccc; }
  button { padding:8px 12px; border:none; border-radius:20px; background:#6200ea; color:white; cursor:pointer; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
<header id="header">
  <img id="opponentIcon" src="https://via.placeholder.com/40">
  <span id="opponentName">ユーザー</span>
</header>

<div id="messages"></div>

<footer>
  <input type="text" id="msgInput" placeholder="メッセージを入力...">
  <button id="sendBtn">送信</button>
</footer>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCEMXXNqQ3U7ojoY9h94X2yeFCJgXNtTwA",
  authDomain: "chatapp-hassu.firebaseapp.com",
  databaseURL: "https://chatapp-hassu-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chatapp-hassu",
  storageBucket: "chatapp-hassu.appspot.com",
  messagingSenderId: "8489684752",
  appId: "1:8489684752:web:8e3fee02ce385cbda11f95"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

const params = new URLSearchParams(window.location.search);
const opponentId = params.get("opponentId");

if(!opponentId) alert("opponentId がありません");

const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const opponentIconImg = document.getElementById("opponentIcon");
const opponentNameSpan = document.getElementById("opponentName");

let currentUser = null;
let opponentData = null;

auth.onAuthStateChanged(user=>{
  if(!user){ location.href="index.html"; return; }
  currentUser = user;

  database.ref("users/"+opponentId).once("value").then(snap=>{
    opponentData = snap.val();
    if(!opponentData) alert("相手が存在しません");
    opponentIconImg.src = opponentData.photoURL || "https://via.placeholder.com/40";
    opponentNameSpan.textContent = opponentData.displayName || "ユーザー";
    startListening();
  });
});

function getChatId(){
  return currentUser.uid < opponentId ? currentUser.uid+"_"+opponentId : opponentId+"_"+currentUser.uid;
}

function startListening(){
  const chatRef = database.ref(`messages/${getChatId()}`);
  chatRef.on("value", snap=>{
    const msgs = snap.val() || {};
    messagesDiv.innerHTML = "";
    Object.entries(msgs).sort((a,b)=>a[1].timestamp-b[1].timestamp).forEach(([key,m])=>{
      const div = document.createElement("div");
      div.className = "msgContainer";

      const msgDiv = document.createElement("div");
      msgDiv.className = m.sender===currentUser.uid ? "msg myMsg" : "msg otherMsg";
      msgDiv.textContent = m.content;

      const iconImg = document.createElement("img");
      iconImg.className="msgIcon";
      iconImg.src = m.sender===currentUser.uid ? currentUser.photoURL : opponentData.photoURL;

      const timeSpan = document.createElement("span");
      timeSpan.className="msgTime";
      timeSpan.textContent = new Date(m.timestamp).toLocaleTimeString();

      const readSpan = document.createElement("span");
      readSpan.className="msgRead";
      readSpan.textContent = (m.sender===currentUser.uid && m.read) ? "既読" : "";

      if(m.sender===currentUser.uid){
        div.appendChild(msgDiv);
        div.appendChild(iconImg);
        div.appendChild(timeSpan);
        div.appendChild(readSpan);
      } else {
        div.appendChild(iconImg);
        div.appendChild(msgDiv);
        div.appendChild(timeSpan);
      }

      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

sendBtn.onclick = ()=>{
  const content = msgInput.value;
  if(!content) return;
  const chatId = getChatId();
  database.ref(`messages/${chatId}`).push({
    sender: currentUser.uid,
    content: content,
    timestamp: Date.now(),
    read: false
  });
  database.ref(`chats/${currentUser.uid}/list/${opponentId}`).set({lastMessage: content});
  database.ref(`chats/${opponentId}/list/${currentUser.uid}`).set({lastMessage: content});
  msgInput.value="";
};
</script>
</body>
</html>
